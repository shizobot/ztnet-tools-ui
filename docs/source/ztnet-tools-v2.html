<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#080c10">
<title>ZTNET Tools</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════
   DESIGN TOKENS
═══════════════════════════════════════════ */
:root {
  --bg:       #06090d;
  --bg2:      #0a0f16;
  --bg3:      #0f1621;
  --bg4:      #141d2b;
  --bg5:      #192336;
  --border:   #1e3048;
  --border2:  #2a4060;
  --text:     #e0eef8;
  --text2:    #90b8d0;
  --text3:    #5a8aaa;
  --accent:   #00ccff;
  --accent2:  #0088bb;
  --green:    #00e8a0;
  --red:      #ff3d55;
  --yellow:   #ffcc00;
  --orange:   #ff8c42;
  --purple:   #9d6fff;
  --r:        8px;
  --r-sm:     5px;
  --sidebar-w: 230px;
  --header-h: 58px;
  --mob-nav-h: 64px;
  --transition: 0.18s cubic-bezier(0.4,0,0.2,1);
}

/* ═══════════════════════════════════════════
   RESET & BASE
═══════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { height: 100%; }

body {
  font-family: 'IBM Plex Mono', monospace;
  background: var(--bg);
  color: var(--text);
  min-height: 100%;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
}

/* Grid bg */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background-image:
    linear-gradient(rgba(0,204,255,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,204,255,0.025) 1px, transparent 1px);
  background-size: 44px 44px;
  pointer-events: none;
}

/* Vignette — subtle edge-only darkening */
body::after {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background: radial-gradient(ellipse 120% 100% at 50% 20%, transparent 60%, rgba(6,9,13,0.25) 100%);
  pointer-events: none;
}

/* ═══════════════════════════════════════════
   HEADER
═══════════════════════════════════════════ */
header {
  position: fixed; top: 0; left: 0; right: 0;
  height: var(--header-h);
  z-index: 200;
  background: rgba(6,9,13,0.92);
  backdrop-filter: blur(16px) saturate(1.2);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px 0 20px;
  gap: 12px;
}

/* Mobile menu toggle */
.menu-btn {
  display: none;
  flex-direction: column;
  justify-content: center;
  gap: 5px;
  width: 40px; height: 40px;
  background: none; border: none; cursor: pointer;
  padding: 8px;
  border-radius: var(--r-sm);
  flex-shrink: 0;
  transition: background var(--transition);
}
.menu-btn:hover { background: var(--bg3); }
.menu-btn span {
  display: block; width: 20px; height: 2px;
  background: var(--text2);
  border-radius: 2px;
  transition: all var(--transition);
}
.menu-btn.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
.menu-btn.open span:nth-child(2) { opacity: 0; transform: scaleX(0); }
.menu-btn.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

.logo {
  display: flex; align-items: center; gap: 10px;
  text-decoration: none;
  flex-shrink: 0;
}

.logo-ring {
  position: relative; width: 34px; height: 34px; flex-shrink: 0;
}
.logo-ring svg { width: 34px; height: 34px; }

.logo-text { font-family: 'Outfit', sans-serif; }
.logo-main { font-size: 17px; font-weight: 800; color: #fff; letter-spacing: 0.02em; line-height: 1; }
.logo-main em { color: var(--accent); font-style: normal; }
.logo-tagline { font-size: 9px; color: #6a9ab8; letter-spacing: 0.15em; font-family: 'IBM Plex Mono', monospace; margin-top: 2px; }

/* Connection bar in header */
.hdr-conn {
  flex: 1; display: flex; align-items: center; gap: 8px;
  margin-left: 8px;
  min-width: 0;
}
.hdr-conn .form-input {
  font-size: 11px;
  height: 32px; padding: 0 10px;
  min-width: 0;
}
.hdr-conn .host-input { flex: 1.2; max-width: 200px; }
.hdr-conn .token-input { flex: 1; max-width: 180px; }
.hdr-conn .btn { height: 32px; padding: 0 14px; font-size: 11px; white-space: nowrap; }

.hdr-right {
  display: flex; align-items: center; gap: 10px;
  flex-shrink: 0;
}

.conn-indicator {
  display: flex; align-items: center; gap: 6px;
  font-size: 10px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 4px 10px;
  white-space: nowrap;
}
.status-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
  transition: background var(--transition), box-shadow var(--transition);
}
.status-dot.online { background: var(--green); box-shadow: 0 0 8px rgba(0,232,160,0.6); animation: blink 2.5s infinite; }
.status-dot.error { background: var(--red); }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.5} }

.node-id-text { color: var(--text2); font-family: 'IBM Plex Mono', monospace; font-size: 10px; }

/* ═══════════════════════════════════════════
   LAYOUT
═══════════════════════════════════════════ */
.app-body {
  display: flex;
  padding-top: var(--header-h);
  min-height: 100vh;
  /* No position/z-index here — avoids creating a stacking context
     that would trap the sidebar below the overlay */
}

/* ═══════════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════════ */
aside#sidebar {
  width: var(--sidebar-w);
  flex-shrink: 0;
  background: var(--bg2);
  border-right: 1px solid var(--border);
  position: fixed;
  top: var(--header-h); bottom: 0; left: 0;
  overflow-y: auto;
  overflow-x: hidden;
  /* z-index: 150 — must be above overlay (130) and mob-nav (190 only on mobile) */
  z-index: 150;
  padding: 12px 0 24px;
  transition: transform var(--transition);
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
  /* isolation:isolate ensures sidebar's own stacking context for its children */
  isolation: isolate;
}

aside#sidebar::-webkit-scrollbar { width: 4px; }
aside#sidebar::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

.sidebar-overlay {
  display: none;
  position: fixed;
  top: var(--header-h); left: 0; right: 0; bottom: 0;
  /* z-index must be BELOW sidebar (150) but above main content */
  z-index: 130;
  background: rgba(0,0,0,0.65);
  /* NO backdrop-filter — creates new stacking context and would blur sidebar */
}

.nav-group { margin-bottom: 4px; }

.nav-group-label {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.18em;
  color: #4a7a9a;
  padding: 10px 20px 6px;
  text-transform: uppercase;
}

.nav-item {
  display: flex; align-items: center;
  gap: 9px;
  padding: 10px 20px;
  cursor: pointer;
  color: #8ab0c8;
  font-size: 12px;
  transition: all var(--transition);
  border-left: 2px solid transparent;
  border-radius: 0 var(--r-sm) var(--r-sm) 0;
  margin: 1px 8px 1px 0;
  position: relative;
  user-select: none;
  -webkit-user-select: none;
}
.nav-item:active { background: var(--bg4) !important; }
.nav-item:hover { color: #d0e8f8; background: var(--bg3); }
.nav-item.active {
  color: var(--accent);
  background: rgba(0,204,255,0.07);
  border-left-color: var(--accent);
  font-weight: 500;
}
.nav-item.active .nav-ic { opacity: 1; }

.nav-ic {
  width: 16px; text-align: center; flex-shrink: 0;
  font-size: 13px; opacity: 0.7;
}

.nav-badge {
  margin-left: auto;
  background: rgba(0,204,255,0.15);
  color: var(--accent);
  border: 1px solid rgba(0,204,255,0.25);
  font-size: 9px;
  font-weight: 600;
  padding: 2px 7px;
  border-radius: 10px;
  min-width: 20px;
  text-align: center;
}

/* ═══════════════════════════════════════════
   MAIN
═══════════════════════════════════════════ */
main {
  flex: 1;
  margin-left: var(--sidebar-w);
  min-width: 0;
  padding: 24px;
  padding-bottom: 32px;
}

/* ═══════════════════════════════════════════
   PANELS
═══════════════════════════════════════════ */
.panel { display: none; }
.panel.active {
  display: block;
  animation: panelIn 0.22s cubic-bezier(0.4,0,0.2,1);
}
@keyframes panelIn {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ═══════════════════════════════════════════
   PAGE HEADER
═══════════════════════════════════════════ */
.page-hdr {
  display: flex; align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 20px;
  gap: 12px;
  flex-wrap: wrap;
}
.page-title {
  font-family: 'Outfit', sans-serif;
  font-size: 24px; font-weight: 700;
  color: #fff; letter-spacing: -0.02em;
  line-height: 1.1;
}
.page-sub {
  font-size: 10px; color: #6a9ab8;
  margin-top: 4px; letter-spacing: 0.05em;
  font-family: 'IBM Plex Mono', monospace;
}
.page-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* ═══════════════════════════════════════════
   CARDS
═══════════════════════════════════════════ */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 20px;
  margin-bottom: 14px;
  position: relative;
  overflow: hidden;
}
.card::after {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent 0%, rgba(0,204,255,0.3) 50%, transparent 100%);
  opacity: 0; transition: opacity 0.3s;
}
.card:hover::after { opacity: 1; }

.card-hdr {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px; gap: 8px;
}
.card-title {
  font-family: 'Outfit', sans-serif;
  font-size: 13px; font-weight: 600;
  color: var(--text); display: flex; align-items: center; gap: 7px;
}
.card-title .ic { color: var(--accent); font-size: 14px; }

/* ═══════════════════════════════════════════
   STATS GRID
═══════════════════════════════════════════ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}
.stat {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 16px;
  position: relative;
  overflow: hidden;
  transition: border-color var(--transition), transform var(--transition);
}
.stat:hover { border-color: var(--border2); transform: translateY(-1px); }
.stat::before {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
  border-radius: 0 0 var(--r) var(--r);
}
.stat.s-blue::before { background: var(--accent); }
.stat.s-green::before { background: var(--green); }
.stat.s-red::before { background: var(--red); }
.stat.s-purple::before { background: var(--purple); }

.stat-lbl { font-size: 9px; text-transform: uppercase; letter-spacing: 0.15em; color: #6a9ab8; margin-bottom: 10px; }
.stat-val {
  font-family: 'Outfit', sans-serif;
  font-size: 32px; font-weight: 800; color: #fff; line-height: 1;
}
.stat-val.c-blue { color: var(--accent); }
.stat-val.c-green { color: var(--green); }
.stat-val.c-red { color: var(--red); }
.stat-val.c-purple { color: var(--purple); font-size: 16px; letter-spacing: 0.05em; }
.stat-note { font-size: 10px; color: #7aaac8; margin-top: 6px; }

/* ═══════════════════════════════════════════
   FORMS
═══════════════════════════════════════════ */
.form-group { margin-bottom: 14px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

/* Inline range: [input] → [input] */
.range-row { display: flex; align-items: center; gap: 8px; }
.range-row .form-input { flex: 1; min-width: 0; }
.range-sep { color: #6a9ab8; font-size: 13px; flex-shrink: 0; padding: 0 2px; user-select: none; }

/* IPv6 section */
.v6-badge {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(157,111,255,0.1); border: 1px solid rgba(157,111,255,0.25);
  color: var(--purple); font-size: 9px; font-weight: 700;
  letter-spacing: 0.12em; padding: 2px 8px; border-radius: 4px;
  text-transform: uppercase;
}

/* ─── Config section headers ─── */
.cfg-section { margin-bottom: 6px; }
.cfg-section-label {
  font-size: 9px; font-weight: 700; letter-spacing: 0.18em;
  text-transform: uppercase; color: #6a9ab8;
  padding: 0 2px 8px;
  display: flex; align-items: center; gap: 8px;
}
.cfg-section-label::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

/* ─── Field hint ─── */
.field-hint {
  font-size: 10px; color: #6a9ab8; line-height: 1.6; margin-top: 5px;
}
.sub-field-label {
  font-size: 9px; font-weight: 700; letter-spacing: 0.1em;
  color: #6a9ab8; margin-bottom: 5px; text-transform: uppercase;
}

/* ─── Toggle switch ─── */
.toggle { display: inline-flex; cursor: pointer; flex-shrink: 0; }
.toggle input { display: none; }
.toggle-track {
  width: 36px; height: 20px; border-radius: 10px;
  background: var(--bg5); border: 1px solid var(--border2);
  position: relative; transition: all var(--transition);
  flex-shrink: 0;
}
.toggle input:checked ~ .toggle-track {
  background: var(--accent); border-color: var(--accent);
  box-shadow: 0 0 8px rgba(0,204,255,0.3);
}
.toggle-thumb {
  position: absolute; top: 2px; left: 2px;
  width: 14px; height: 14px; border-radius: 50%;
  background: #fff; transition: transform var(--transition);
  box-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
.toggle input:checked ~ .toggle-track .toggle-thumb { transform: translateX(16px); }
.toggle-row {
  display: flex; align-items: flex-start; gap: 12px;
  margin-bottom: 14px;
}
.toggle-row:last-child { margin-bottom: 0; }

/* ─── Access Control radio ─── */
.access-radio-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.access-radio { display: block; cursor: pointer; }
.access-radio input { display: none; }
.access-radio-body {
  display: flex; gap: 12px; align-items: flex-start;
  padding: 14px; border-radius: var(--r);
  border: 2px solid var(--border);
  background: var(--bg3);
  transition: all var(--transition);
}
.access-radio:hover .access-radio-body { border-color: var(--border2); background: var(--bg4); }
.access-radio input:checked ~ .access-radio-body {
  border-color: var(--accent);
  background: rgba(0,204,255,0.05);
  box-shadow: 0 0 0 1px rgba(0,204,255,0.15);
}
.access-radio-icon { font-size: 22px; flex-shrink: 0; margin-top: 1px; }
.access-radio-title { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.access-radio-desc { font-size: 10px; color: #6a9ab8; line-height: 1.6; }

/* ─── IP range grid (Easy tab) ─── */
.ip-range-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}
.ip-range-btn {
  padding: 8px 6px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--r-sm);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; color: #90b8d0;
  cursor: pointer; text-align: center;
  transition: all var(--transition);
  user-select: none; -webkit-user-select: none;
}
.ip-range-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,204,255,0.06); }
.ip-range-btn.selected {
  border-color: var(--accent); color: var(--accent);
  background: rgba(0,204,255,0.1);
  box-shadow: 0 0 0 1px rgba(0,204,255,0.2);
}

/* ─── Add sub-card (add-route / add-pool inline form) ─── */
.add-sub-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 12px 14px; margin-top: 10px;
}
.add-sub-title {
  font-size: 10px; font-weight: 700; letter-spacing: 0.1em;
  text-transform: uppercase; color: #7aaac8; margin-bottom: 10px;
}

/* ─── Route row (enhanced) ─── */
.route-row {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 10px; border-radius: var(--r-sm);
  background: var(--bg3); border: 1px solid var(--border);
  margin-bottom: 5px; flex-wrap: wrap;
}
.route-tgt { font-weight: 600; color: var(--text); font-size: 12px; }
.route-via { color: #6a9ab8; font-size: 10px; }
.route-tag {
  font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: 600;
  letter-spacing: 0.08em;
}
.route-tag.lan  { background: rgba(0,232,160,0.1); color: var(--green); border: 1px solid rgba(0,232,160,0.2); }
.route-tag.dflt { background: rgba(255,140,66,0.1); color: var(--orange); border: 1px solid rgba(255,140,66,0.2); }
.route-tag.pub  { background: rgba(255,204,0,0.1); color: var(--yellow); border: 1px solid rgba(255,204,0,0.2); }

/* ─── DNS server row ─── */
.dns-server-row {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 10px; border-radius: var(--r-sm);
  background: var(--bg3); border: 1px solid var(--border);
  margin-bottom: 5px;
  font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--text);
}
.dns-server-row .dns-ip { flex: 1; }

/* ─── Collapsible advanced section ─── */
.collapsible-hdr {
  display: flex; align-items: center; justify-content: space-between;
  cursor: pointer; padding: 10px 0; user-select: none;
  border-bottom: 1px solid var(--border);
  margin-bottom: 14px;
}
.collapsible-hdr:hover .collapsible-title { color: var(--accent); }
.collapsible-title { font-size: 12px; font-weight: 600; color: var(--text2); }
.collapsible-arrow { color: #6a9ab8; font-size: 10px; transition: transform var(--transition); }
.collapsible-hdr.open .collapsible-arrow { transform: rotate(180deg); }

/* ─── IPv6 mode toggle cards (legacy, kept for fallback) ─── */
/* IPv6 mode toggle cards */
.v6-mode-card {
  background: var(--bg4);
  border: 2px solid var(--border);
  border-radius: var(--r);
  padding: 14px;
  cursor: pointer;
  transition: all var(--transition);
  user-select: none; -webkit-user-select: none;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.v6-mode-card:hover { border-color: var(--border2); background: var(--bg5); }
.v6-mode-card.active {
  border-color: var(--purple);
  background: rgba(157,111,255,0.08);
  box-shadow: 0 0 16px rgba(157,111,255,0.12);
}
.v6-mode-card.active::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: var(--purple);
}
.v6-mode-icon { font-size: 20px; color: var(--text3); margin-bottom: 6px; transition: color var(--transition); }
.v6-mode-card.active .v6-mode-icon { color: var(--purple); }
.v6-mode-name {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12px; font-weight: 600;
  color: var(--text); margin-bottom: 6px;
}
.v6-mode-desc { font-size: 10px; color: #6a9ab8; line-height: 1.55; margin-bottom: 10px; }
.v6-mode-status {
  display: inline-block;
  font-size: 9px; font-weight: 700; letter-spacing: 0.12em;
  padding: 3px 8px; border-radius: 4px;
  background: rgba(106,154,184,0.1); color: #6a9ab8;
  border: 1px solid rgba(106,154,184,0.2);
  transition: all var(--transition);
}
.v6-mode-card.active .v6-mode-status {
  background: rgba(157,111,255,0.15); color: var(--purple);
  border-color: rgba(157,111,255,0.3);
}
.tunnel-block {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--r); margin-bottom: 8px; overflow: hidden;
}
.tunnel-block-hdr {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; cursor: pointer; transition: background var(--transition);
  user-select: none; -webkit-user-select: none;
}
.tunnel-block-hdr:hover { background: var(--bg4); }
.tunnel-block-hl { display: flex; align-items: center; gap: 10px; }
.tunnel-block-title { font-size: 12px; font-weight: 600; color: var(--text); }
.tunnel-block-sub { font-size: 10px; color: #7aaac8; margin-top: 2px; }
.tunnel-arrow { color: #6a9ab8; font-size: 11px; transition: transform var(--transition); flex-shrink: 0; }
.tunnel-block.open .tunnel-arrow { transform: rotate(180deg); }
.tunnel-block-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); padding-top: 14px; }
.tunnel-block.open .tunnel-block-body { display: block; }
.tunnel-chip {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--bg4); border: 1px solid var(--border2);
  border-radius: 4px; padding: 3px 9px;
  font-size: 10px; color: var(--text2); margin: 2px 2px 2px 0;
}

label.lbl {
  display: block;
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  color: #7aaac8; margin-bottom: 6px;
}

.form-input, .form-select, textarea.form-input {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 10px 12px;
  color: var(--text);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12px;
  outline: none;
  transition: border-color var(--transition), box-shadow var(--transition);
  -webkit-appearance: none;
  appearance: none;
}
.form-input:focus, .form-select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(0,204,255,0.12);
}
.form-input::placeholder { color: #4a7a9a; }
.form-input[readonly] { opacity: 0.65; cursor: default; }
textarea.form-input { resize: vertical; line-height: 1.55; min-height: 80px; }
select.form-select option { background: var(--bg3); }

/* ═══════════════════════════════════════════
   BUTTONS
═══════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 10px 18px;
  border-radius: var(--r-sm);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12px; font-weight: 500;
  cursor: pointer; border: none;
  transition: all var(--transition);
  letter-spacing: 0.03em;
  white-space: nowrap;
  user-select: none; -webkit-user-select: none;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.btn:active { transform: scale(0.97); }

.btn-primary { background: var(--accent); color: #000; font-weight: 600; }
.btn-primary:hover { background: #33d9ff; box-shadow: 0 4px 20px rgba(0,204,255,0.35); }

.btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); }
.btn-ghost:hover { background: var(--bg3); color: var(--text); border-color: var(--border2); }

.btn-danger { background: transparent; color: var(--red); border: 1px solid rgba(255,61,85,0.25); }
.btn-danger:hover { background: rgba(255,61,85,0.1); border-color: var(--red); }

.btn-success { background: transparent; color: var(--green); border: 1px solid rgba(0,232,160,0.25); }
.btn-success:hover { background: rgba(0,232,160,0.1); border-color: var(--green); }

.btn-warn { background: transparent; color: var(--yellow); border: 1px solid rgba(255,204,0,0.25); }
.btn-warn:hover { background: rgba(255,204,0,0.1); border-color: var(--yellow); }

.btn-sm { padding: 6px 12px; font-size: 11px; }
.btn-icon { padding: 8px; width: 34px; height: 34px; justify-content: center; }
.btn-full { width: 100%; justify-content: center; }

/* Loading state */
.btn.loading { opacity: 0.7; pointer-events: none; }
.btn.loading::after {
  content: '';
  width: 12px; height: 12px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: currentColor;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  margin-left: 4px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ═══════════════════════════════════════════
   BADGES
═══════════════════════════════════════════ */
.badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; font-weight: 500;
  padding: 3px 8px; border-radius: 4px;
  letter-spacing: 0.04em;
}
.b-green { background: rgba(0,232,160,0.1); color: var(--green); border: 1px solid rgba(0,232,160,0.2); }
.b-red   { background: rgba(255,61,85,0.1);  color: var(--red);   border: 1px solid rgba(255,61,85,0.2); }
.b-blue  { background: rgba(0,204,255,0.1);  color: var(--accent);border: 1px solid rgba(0,204,255,0.2); }
.b-gray  { background: rgba(106,143,168,0.1);color: var(--text2); border: 1px solid rgba(106,143,168,0.15); }
.b-yellow{ background: rgba(255,204,0,0.1);  color: var(--yellow);border: 1px solid rgba(255,204,0,0.2); }
.b-orange{ background: rgba(255,140,66,0.1); color: var(--orange);border: 1px solid rgba(255,140,66,0.2); }

/* ═══════════════════════════════════════════
   TOGGLE SWITCH
═══════════════════════════════════════════ */
.toggle { position: relative; display: inline-block; width: 38px; height: 22px; flex-shrink: 0; }
.toggle input { display: none; }
.toggle-track {
  position: absolute; inset: 0;
  background: var(--bg5); border: 1px solid var(--border2);
  border-radius: 22px; cursor: pointer; transition: all var(--transition);
}
.toggle-thumb {
  position: absolute;
  width: 16px; height: 16px;
  top: 2px; left: 2px;
  background: var(--text3); border-radius: 50%;
  transition: all var(--transition);
  box-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
.toggle input:checked ~ .toggle-track { background: rgba(0,232,160,0.15); border-color: var(--green); }
.toggle input:checked ~ .toggle-track .toggle-thumb {
  background: var(--green); transform: translateX(16px);
  box-shadow: 0 0 8px rgba(0,232,160,0.5);
}

/* ═══════════════════════════════════════════
   TABLES
═══════════════════════════════════════════ */
.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 500px; }
thead tr { border-bottom: 1px solid var(--border); }
th {
  text-align: left; font-size: 9px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.14em;
  color: #6a9ab8; padding: 8px 12px;
}
tbody tr {
  border-bottom: 1px solid rgba(26,42,58,0.5);
  transition: background var(--transition);
}
tbody tr:hover { background: rgba(0,204,255,0.025); }
td { padding: 11px 12px; color: var(--text); vertical-align: middle; }
td.mono { font-family: 'IBM Plex Mono', monospace; color: var(--text2); font-size: 11px; }

/* ═══════════════════════════════════════════
   NETWORK CARDS
═══════════════════════════════════════════ */
.net-card {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 8px;
  display: flex; align-items: center;
  gap: 12px; cursor: pointer;
  transition: all var(--transition);
  position: relative; overflow: hidden;
}
.net-card::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
  background: var(--accent); opacity: 0;
  transition: opacity var(--transition);
}
.net-card:hover { border-color: var(--border2); background: var(--bg4); }
.net-card:hover::before { opacity: 1; }
.net-card.selected { border-color: rgba(0,204,255,0.4); background: rgba(0,204,255,0.04); }
.net-card.selected::before { opacity: 1; }
.net-card:active { transform: scale(0.99); }

.net-id {
  font-size: 13px; color: var(--accent); font-weight: 600;
  letter-spacing: 0.06em; font-family: 'IBM Plex Mono', monospace;
  min-width: 160px; flex-shrink: 0;
}
.net-name { flex: 1; font-size: 12px; color: var(--text); min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.net-meta { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.net-actions { display: flex; gap: 6px; opacity: 0; transition: opacity var(--transition); flex-shrink: 0; }
.net-card:hover .net-actions { opacity: 1; }

/* ═══════════════════════════════════════════
   RESPONSE BOX
═══════════════════════════════════════════ */
.resp {
  background: rgba(0,0,0,0.4);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 14px;
  font-size: 11px; line-height: 1.65;
  color: var(--text2);
  white-space: pre-wrap; word-break: break-all;
  max-height: 320px; overflow-y: auto;
  font-family: 'IBM Plex Mono', monospace;
  transition: border-color var(--transition);
}
.resp.ok  { border-color: rgba(0,232,160,0.3); color: var(--green); }
.resp.err { border-color: rgba(255,61,85,0.3);  color: var(--red); }

/* ═══════════════════════════════════════════
   TERMINAL / CODE BLOCK
═══════════════════════════════════════════ */
.terminal {
  background: #000d06;
  border: 1px solid #0f2a1a;
  border-radius: var(--r); overflow: hidden;
}
.terminal-hdr {
  background: #0a1f12;
  padding: 9px 14px;
  display: flex; align-items: center; gap: 6px;
  border-bottom: 1px solid #0f2a1a;
}
.term-dot { width: 10px; height: 10px; border-radius: 50%; }
.term-title { margin-left: 8px; font-size: 10px; color: #2a5a2a; }
.terminal-body {
  padding: 16px; font-size: 11px; line-height: 1.9;
  color: #00e060; font-family: 'IBM Plex Mono', monospace;
  max-height: 280px; overflow-y: auto;
  overflow-x: auto;
}
.terminal-body .c  { color: #2a5a2a; }
.terminal-body .cmd{ color: #00aaee; word-break: break-all; }
.terminal-body .out{ color: #60bb60; }
.terminal-body .p  { color: #4a8a4a; }
.terminal-body .hl { color: var(--accent); }

/* ═══════════════════════════════════════════
   IP TAGS
═══════════════════════════════════════════ */
.tag-box {
  display: flex; flex-wrap: wrap; gap: 5px;
  padding: 8px; min-height: 42px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  transition: border-color var(--transition);
}
.tag-box:focus-within { border-color: var(--accent); }
.ip-tag {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--bg4); border: 1px solid var(--border2);
  border-radius: 4px; padding: 3px 8px;
  font-size: 11px; color: var(--text2);
}
.ip-tag button {
  background: none; border: none; color: #6a9ab8;
  cursor: pointer; padding: 0; line-height: 1; font-size: 13px;
  transition: color var(--transition);
  touch-action: manipulation;
}
.ip-tag button:hover { color: var(--red); }

/* ═══════════════════════════════════════════
   ROUTE ROWS
═══════════════════════════════════════════ */
.route-row {
  display: flex; align-items: center; gap: 8px;
  padding: 9px 12px;
  background: var(--bg4);
  border: 1px solid var(--border);
  border-radius: var(--r-sm); margin-bottom: 6px;
  font-size: 11px; color: var(--text2);
}
.route-tgt { flex: 1; color: var(--text); font-weight: 500; }
.route-via { color: #6a9ab8; font-size: 10px; }

/* ═══════════════════════════════════════════
   DIVIDER / NOTICE
═══════════════════════════════════════════ */
.divider { height: 1px; background: var(--border); margin: 18px 0; }

.notice {
  border-radius: var(--r-sm); padding: 12px 14px;
  font-size: 11px; color: var(--text2);
  margin-bottom: 14px;
  display: flex; gap: 10px; align-items: flex-start;
  border-left: 3px solid transparent;
  line-height: 1.55;
}
.notice.info  { background: rgba(0,204,255,0.05);  border-color: rgba(0,204,255,0.4);  }
.notice.warn  { background: rgba(255,204,0,0.05);   border-color: rgba(255,204,0,0.5);   }
.notice.error { background: rgba(255,61,85,0.05);   border-color: rgba(255,61,85,0.5);   }
.notice-icon  { flex-shrink: 0; font-size: 14px; margin-top: 1px; }
.notice.info  .notice-icon { color: var(--accent); }
.notice.warn  .notice-icon { color: var(--yellow); }
.notice.error .notice-icon { color: var(--red); }

/* ═══════════════════════════════════════════
   TABS
═══════════════════════════════════════════ */
.tab-bar {
  display: flex; gap: 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: 18px;
  overflow-x: auto; scrollbar-width: none;
  -webkit-overflow-scrolling: touch;
}
.tab-bar::-webkit-scrollbar { display: none; }
.tab {
  padding: 9px 14px;
  font-size: 11px; color: #6a9ab8;
  cursor: pointer; border-bottom: 2px solid transparent;
  transition: all var(--transition);
  margin-bottom: -1px; white-space: nowrap;
  user-select: none; -webkit-user-select: none;
  touch-action: manipulation;
}
.tab:hover { color: var(--text2); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* ═══════════════════════════════════════════
   SEARCH BAR
═══════════════════════════════════════════ */
.search-bar {
  position: relative; margin-bottom: 14px;
}
.search-bar .search-ic {
  position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
  color: #6a9ab8; pointer-events: none; font-size: 13px;
}
.search-bar .form-input { padding-left: 36px; }

/* ═══════════════════════════════════════════
   INLINE SPINNER
═══════════════════════════════════════════ */
.spinner {
  display: inline-block; width: 14px; height: 14px;
  border: 2px solid var(--border2); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.7s linear infinite;
  flex-shrink: 0;
}

/* ═══════════════════════════════════════════
   EMPTY STATE
═══════════════════════════════════════════ */
.empty {
  text-align: center; padding: 48px 24px;
  color: #6a9ab8; font-size: 12px;
}
.empty-icon { font-size: 36px; margin-bottom: 12px; opacity: 0.4; }
.empty-title { font-family: 'Outfit', sans-serif; font-size: 15px; color: #90b8d0; margin-bottom: 6px; }

/* ═══════════════════════════════════════════
   TOAST
═══════════════════════════════════════════ */
#toast-wrap {
  position: fixed; bottom: 20px; right: 20px;
  z-index: 9999; display: flex; flex-direction: column; gap: 8px;
  pointer-events: none; max-width: calc(100vw - 40px);
}
.toast {
  background: var(--bg3); border: 1px solid var(--border2);
  border-radius: var(--r); padding: 11px 16px;
  font-size: 12px; color: var(--text);
  box-shadow: 0 8px 40px rgba(0,0,0,0.5);
  display: flex; align-items: center; gap: 9px;
  animation: toastIn 0.25s ease, toastOut 0.3s ease 2.7s forwards;
  max-width: 360px;
}
.toast.ok  { border-color: rgba(0,232,160,0.35); }
.toast.err { border-color: rgba(255,61,85,0.35); }
@keyframes toastIn  { from { transform: translateX(110%); opacity: 0; } to { transform: none; opacity: 1; } }
@keyframes toastOut { to   { transform: translateX(20px); opacity: 0; } }

/* ═══════════════════════════════════════════
   MOBILE BOTTOM NAV
═══════════════════════════════════════════ */
#mob-nav {
  display: none;
  position: fixed; bottom: 0; left: 0; right: 0;
  height: var(--mob-nav-h);
  background: rgba(6,9,13,0.96);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  z-index: 190;
  padding: 0 8px;
  overflow-x: auto; scrollbar-width: none;
  -webkit-overflow-scrolling: touch;
  justify-content: space-around;
  align-items: center;
}
#mob-nav::-webkit-scrollbar { display: none; }
.mob-nav-item {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 4px; flex: 1; min-width: 56px;
  padding: 8px 4px; cursor: pointer;
  border-radius: var(--r-sm);
  transition: all var(--transition);
  user-select: none; -webkit-user-select: none;
  touch-action: manipulation; position: relative;
}
.mob-nav-item:active { background: var(--bg3); transform: scale(0.95); }
.mob-nav-icon { font-size: 18px; color: #6a9ab8; transition: color var(--transition); }
.mob-nav-lbl  { font-size: 9px; color: #6a9ab8; transition: color var(--transition); letter-spacing: 0.05em; }
.mob-nav-item.active .mob-nav-icon { color: var(--accent); }
.mob-nav-item.active .mob-nav-lbl  { color: var(--accent); }
.mob-nav-badge {
  position: absolute; top: 4px; right: 6px;
  background: var(--red); color: #fff;
  font-size: 8px; font-weight: 700;
  padding: 1px 5px; border-radius: 8px;
  min-width: 14px; text-align: center;
  display: none;
}
.mob-nav-badge.show { display: block; }

/* ═══════════════════════════════════════════
   FAB (Floating Action Button)
═══════════════════════════════════════════ */
#fab {
  display: none;
  position: fixed; bottom: calc(var(--mob-nav-h) + 16px); right: 16px;
  width: 52px; height: 52px; border-radius: 50%;
  background: var(--accent); color: #000;
  font-size: 22px; font-weight: 700;
  border: none; cursor: pointer; z-index: 180;
  align-items: center; justify-content: center;
  box-shadow: 0 4px 24px rgba(0,204,255,0.4);
  transition: all var(--transition);
  touch-action: manipulation;
}
#fab:active { transform: scale(0.92); }

/* ═══════════════════════════════════════════
   UTILITIES
═══════════════════════════════════════════ */
.flex        { display: flex; }
.flex-col    { flex-direction: column; }
.items-ctr   { align-items: center; }
.gap-6       { gap: 6px; }
.gap-8       { gap: 8px; }
.gap-12      { gap: 12px; }
.ml-auto     { margin-left: auto; }
.mb-0        { margin-bottom: 0 !important; }
.mb-8        { margin-bottom: 8px; }
.mb-14       { margin-bottom: 14px; }
.mt-12       { margin-top: 12px; }
.hidden      { display: none !important; }
.w-full      { width: 100%; }
.copy-btn {
  background: none; border: none; color: #6a9ab8;
  cursor: pointer; font-size: 12px; padding: 2px 6px;
  border-radius: var(--r-sm); transition: color var(--transition);
  font-family: 'IBM Plex Mono', monospace;
}
.copy-btn:hover { color: var(--accent); }

/* ═══════════════════════════════════════════
   SCROLLBAR GLOBAL
═══════════════════════════════════════════ */
::-webkit-scrollbar       { width: 5px; height: 5px; }
::-webkit-scrollbar-track  { background: transparent; }
::-webkit-scrollbar-thumb  { background: var(--border2); border-radius: 3px; }

/* ═══════════════════════════════════════════
   MOBILE RESPONSIVE — 768px
═══════════════════════════════════════════ */
@media (max-width: 768px) {
  :root {
    --header-h: 54px;
  }

  /* Header — collapse connection bar */
  .hdr-conn { display: none; }
  .menu-btn { display: flex; }

  /* Sidebar becomes a drawer */
  aside#sidebar {
    transform: translateX(-100%);
    top: 0; bottom: var(--mob-nav-h);
    z-index: 300;
    border-right: 1px solid var(--border2);
    box-shadow: 4px 0 40px rgba(0,0,0,0.6);
    padding-top: calc(var(--header-h) + 8px);
  }
  aside#sidebar.open { transform: translateX(0); }
  .sidebar-overlay.show { display: block; top: 0; } /* cover full screen on mobile */

  /* Main: no left margin, bottom padding for nav */
  main {
    margin-left: 0;
    padding: 16px;
    padding-bottom: calc(var(--mob-nav-h) + 80px);
  }

  /* Stats: 2-col on mobile */
  .stats-row { grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .stat-val { font-size: 26px; }
  .stat-val.c-purple { font-size: 13px; }

  /* Page header stack */
  .page-hdr { flex-direction: column; margin-bottom: 16px; }
  .page-title { font-size: 20px; }
  .page-actions { width: 100%; }
  .page-actions .btn { flex: 1; justify-content: center; }

  /* Form rows: single col on mobile */
  .form-row, .form-row-3 { grid-template-columns: 1fr; }

  /* Range rows stack vertically on mobile */
  .range-row { flex-wrap: wrap; }
  .range-row .form-input { min-width: 120px; }
  .range-sep { display: none; }

  /* v6 mode grid: single column on mobile */
  #v6ModeGrid { grid-template-columns: 1fr !important; }

  /* Access radio: single column on mobile */
  .access-radio-group { grid-template-columns: 1fr; }

  /* IP range grid: 2 columns on mobile */
  .ip-range-grid { grid-template-columns: repeat(2, 1fr); }

  /* Cards: tighter padding */
  .card { padding: 14px; }

  /* Network cards: stack */
  .net-card { flex-direction: column; align-items: flex-start; gap: 8px; }
  .net-id   { min-width: unset; font-size: 12px; }
  .net-actions { opacity: 1; width: 100%; }
  .net-actions .btn { flex: 1; justify-content: center; font-size: 11px; }

  /* Tables: hide less-important cols, show actions */
  .tbl-hide-mob { display: none !important; }

  /* Bottom nav */
  #mob-nav { display: flex; }

  /* FAB */
  #fab { display: flex; }

  /* Hide desktop-only elements */
  .desk-only { display: none !important; }

  /* Connection bar: dedicated mobile section */
  #mob-conn-card { display: block; }

  /* Route rows: wrap */
  .route-row { flex-wrap: wrap; }

  /* Tabs: horizontal scroll */
  .tab { padding: 9px 11px; font-size: 10px; }

  /* Response box */
  .resp { max-height: 220px; font-size: 10px; }

  /* Terminal */
  .terminal-body { font-size: 10px; max-height: 200px; }

  /* Toast: left aligned */
  #toast-wrap { right: 12px; bottom: calc(var(--mob-nav-h) + 12px); left: 12px; }
  .toast { max-width: none; font-size: 11px; }
}

/* ═══════════════════════════════════════════
   TABLET — 1024px
═══════════════════════════════════════════ */
@media (max-width: 1024px) and (min-width: 769px) {
  :root { --sidebar-w: 190px; }
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .hdr-conn .host-input { max-width: 150px; }
  .hdr-conn .token-input { max-width: 140px; }
}

/* Hidden mobile-connection card by default */
#mob-conn-card { display: none; }

</style>
</head>
<body>

<!-- ═══ HEADER ═══ -->
<header>
  <button class="menu-btn" id="menuBtn" onclick="toggleSidebar()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>

  <a class="logo" href="#" onclick="navigate('/'); return false;">
    <div class="logo-ring">
      <svg viewBox="0 0 34 34" fill="none">
        <circle cx="17" cy="17" r="15" stroke="#00ccff" stroke-width="1" opacity="0.2"/>
        <circle cx="17" cy="17" r="9"  stroke="#00ccff" stroke-width="1" opacity="0.5"/>
        <circle cx="17" cy="17" r="3.5" fill="#00ccff"/>
        <line x1="17" y1="2"  x2="17" y2="32" stroke="#00ccff" stroke-width="0.6" opacity="0.2"/>
        <line x1="2"  y1="17" x2="32" y2="17" stroke="#00ccff" stroke-width="0.6" opacity="0.2"/>
        <circle cx="17" cy="2"  r="1.5" fill="#00ccff" opacity="0.5"/>
        <circle cx="32" cy="17" r="1.5" fill="#00ccff" opacity="0.5"/>
        <circle cx="17" cy="32" r="1.5" fill="#00ccff" opacity="0.5"/>
        <circle cx="2"  cy="17" r="1.5" fill="#00ccff" opacity="0.5"/>
        <circle cx="26.5" cy="7.5"  r="1.5" fill="#00ccff" opacity="0.3"/>
        <circle cx="7.5"  cy="26.5" r="1.5" fill="#00ccff" opacity="0.3"/>
      </svg>
    </div>
    <div class="logo-text">
      <div class="logo-main">ZT<em>NET</em></div>
      <div class="logo-tagline">CONTROLLER TOOLS</div>
    </div>
  </a>

  <!-- Connection bar (desktop) -->
  <div class="hdr-conn">
    <input class="form-input host-input" id="apiHost" placeholder="http://localhost:9993" value="http://localhost:9993" autocomplete="off" spellcheck="false">
    <input class="form-input token-input" id="apiToken" type="password" placeholder="X-ZT1-AUTH token" autocomplete="off">
    <button class="btn btn-primary" id="connectBtn" onclick="testConnection()">⚡ Connect</button>
  </div>

  <div class="hdr-right">
    <div class="conn-indicator">
      <div class="status-dot" id="statusDot"></div>
      <span class="node-id-text" id="headerNodeId">NOT CONNECTED</span>
    </div>
  </div>
</header>

<!-- ═══ SIDEBAR OVERLAY ═══ -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- ═══ APP BODY ═══ -->
<div class="app-body">

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="nav-group">
      <div class="nav-group-label">Overview</div>
      <div class="nav-item active" onclick="navigate('/')" data-route-key="dashboard">
        <span class="nav-ic">⬡</span> Dashboard
      </div>
      <div class="nav-item" onclick="navigate('/status')" data-route-key="status">
        <span class="nav-ic">◉</span> Node Status
      </div>
    </div>
    <div class="nav-group">
      <div class="nav-group-label">Networks</div>
      <div class="nav-item" onclick="navigate('/networks')" data-route-key="networks">
        <span class="nav-ic">⬢</span> All Networks
        <span class="nav-badge" id="netBadge">0</span>
      </div>
      <div class="nav-item" onclick="navigate('/networks/create')" data-route-key="create-network">
        <span class="nav-ic">⊕</span> Create Network
      </div>
      <div class="nav-item" onclick="navigate(S.selectedNwid ? `/networks/${S.selectedNwid}` : '/networks')" data-route-key="network-config">
        <span class="nav-ic">⚙</span> Configure Network
      </div>
    </div>
    <div class="nav-group">
      <div class="nav-group-label">Members</div>
      <div class="nav-item" onclick="navigate('/members')" data-route-key="members">
        <span class="nav-ic">◎</span> Members
        <span class="nav-badge" id="memBadge">0</span>
      </div>
      <div class="nav-item" onclick="navigate((S.selectedNwid && getVal('detailMemid')) ? `/members/${S.selectedNwid}/${getVal('detailMemid')}` : '/members')" data-route-key="member-detail">
        <span class="nav-ic">◐</span> Member Detail
      </div>
    </div>
    <div class="nav-group">
      <div class="nav-group-label">Developer</div>
      <div class="nav-item" onclick="navigate('/api')" data-route-key="raw-api">
        <span class="nav-ic">≺/≻</span> Raw API
      </div>
      <div class="nav-item" onclick="navigate('/curl')" data-route-key="terminal">
        <span class="nav-ic">$_</span> cURL Builder
      </div>
    </div>
    <div class="nav-group">
      <div class="nav-group-label">System</div>
      <div class="nav-item" onclick="navigate('/settings')" data-route-key="settings">
        <span class="nav-ic">◧</span> Connection
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main id="main">

    <!-- MOBILE CONNECTION CARD (shown only on mobile) -->
    <div id="mob-conn-card" class="card mb-14">
      <div class="card-title" style="margin-bottom:12px"><span class="ic">⚡</span> Controller Connection</div>
      <div class="form-group">
        <label class="lbl">API Host</label>
        <input class="form-input" id="mobApiHost" placeholder="http://localhost:9993" value="http://localhost:9993" autocomplete="off">
      </div>
      <div class="form-group mb-0">
        <label class="lbl">Auth Token</label>
        <input class="form-input" id="mobApiToken" type="password" placeholder="X-ZT1-AUTH token" autocomplete="off">
      </div>
      <div style="margin-top:12px">
        <button class="btn btn-primary btn-full" onclick="testConnectionMobile()">⚡ Connect to Controller</button>
      </div>
    </div>

    <!-- ════════════════ DASHBOARD ════════════════ -->
    <div class="panel active" id="panel-dashboard">
      <div class="page-hdr">
        <div>
          <div class="page-title">Dashboard</div>
          <div class="page-sub">ZeroTier Controller Overview</div>
        </div>
        <div class="page-actions">
          <button class="btn btn-ghost btn-sm" onclick="refreshDashboard()">↻ Refresh</button>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat s-blue">
          <div class="stat-lbl">Networks</div>
          <div class="stat-val c-blue" id="statNetworks">—</div>
          <div class="stat-note">total managed</div>
        </div>
        <div class="stat s-green">
          <div class="stat-lbl">Authorized</div>
          <div class="stat-val c-green" id="statAuthorized">—</div>
          <div class="stat-note">active members</div>
        </div>
        <div class="stat s-red">
          <div class="stat-lbl">Pending</div>
          <div class="stat-val c-red" id="statPending">—</div>
          <div class="stat-note">awaiting auth</div>
        </div>
        <div class="stat s-purple">
          <div class="stat-lbl">Node ID</div>
          <div class="stat-val c-purple" id="statNodeId">—</div>
          <div class="stat-note">controller addr</div>
        </div>
      </div>

      <div class="card">
        <div class="card-hdr">
          <div class="card-title"><span class="ic">⬢</span> Networks</div>
          <button class="btn btn-ghost btn-sm" onclick="navigate('/networks/create')">⊕ New</button>
        </div>
        <div id="dashNetworks">
          <div class="empty">
            <div class="empty-icon">⬡</div>
            <div class="empty-title">Not connected</div>
            Connect to your controller to load networks
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-hdr">
          <div class="card-title"><span class="ic">◉</span> Controller Info</div>
        </div>
        <div id="dashStatus" style="font-size:11px;color:#6a9ab8;line-height:1.8">Not connected.</div>
      </div>
    </div>

    <!-- ════════════════ STATUS ════════════════ -->
    <div class="panel" id="panel-status">
      <div class="page-hdr">
        <div>
          <div class="page-title">Node Status</div>
          <div class="page-sub">GET /status</div>
        </div>
        <div class="page-actions">
          <button class="btn btn-ghost btn-sm" onclick="loadStatus()">↻ Refresh</button>
          <button class="copy-btn" onclick="copyEl('statusOutput')">⎘ Copy</button>
        </div>
      </div>
      <div class="card mb-0">
        <div class="resp" id="statusOutput">Connect and click Refresh to load status.</div>
      </div>
    </div>

    <!-- ════════════════ NETWORKS ════════════════ -->
    <div class="panel" id="panel-networks">
      <div class="page-hdr">
        <div>
          <div class="page-title">Networks</div>
          <div class="page-sub">GET /controller/network</div>
        </div>
        <div class="page-actions">
          <button class="btn btn-ghost btn-sm" onclick="loadNetworks()">↻ Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="navigate('/networks/create')">⊕ Create</button>
        </div>
      </div>
      <div class="search-bar">
        <span class="search-ic">⌕</span>
        <input class="form-input" id="netSearch" placeholder="Filter networks..." oninput="filterNetworks()">
      </div>
      <div class="card">
        <div id="networksList">
          <div class="empty">
            <div class="empty-icon">⬢</div>
            <div class="empty-title">No networks loaded</div>
            Connect and refresh to load your networks
          </div>
        </div>
      </div>
    </div>

    <!-- ════════════════ CREATE NETWORK ════════════════ -->
    <div class="panel" id="panel-create-network">
      <div class="page-hdr">
        <div>
          <div class="page-title">Create Network</div>
          <div class="page-sub">POST /controller/network/{nodeId}______</div>
        </div>
        <div class="page-actions">
          <button class="btn btn-ghost btn-sm" onclick="fillDefaults()">⊛ Fill Defaults</button>
        </div>
      </div>
      <div class="notice info">
        <span class="notice-icon">ℹ</span>
        <span>The Network ID is auto-generated from your Node ID + 6 random chars. Connect first so your Node ID is loaded.</span>
      </div>

      <!-- ── Basics ── -->
      <div class="cfg-section">
        <div class="cfg-section-label">Basics</div>
        <div class="card">
          <div class="form-row">
            <div class="form-group mb-0">
              <label class="lbl">Name</label>
              <input class="form-input" id="newNetName" placeholder="e.g. home.lab or work.vpn" autocomplete="off">
              <div class="field-hint">Short human-readable name visible to members.</div>
            </div>
            <div class="form-group mb-0">
              <label class="lbl">Description <span style="color:#4a7a9a;font-weight:400">(optional)</span></label>
              <input class="form-input" id="newNetDesc" placeholder="Optional longer description" autocomplete="off">
              <div class="field-hint">Stored on controller only, not sent to members.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── Access Control ── -->
      <div class="cfg-section">
        <div class="cfg-section-label">Access Control</div>
        <div class="card">
          <div class="access-radio-group">
            <label class="access-radio" id="newAcl-private">
              <input type="radio" name="newAccess" value="true" id="newAclPrivate" checked onchange="setNewPrivate(true)">
              <div class="access-radio-body">
                <div class="access-radio-icon">🔒</div>
                <div>
                  <div class="access-radio-title">Private</div>
                  <div class="access-radio-desc">Nodes must be authorized to become members. Recommended for all real networks.</div>
                </div>
              </div>
            </label>
            <label class="access-radio" id="newAcl-public">
              <input type="radio" name="newAccess" value="false" id="newAclPublic" onchange="setNewPrivate(false)">
              <div class="access-radio-body">
                <div class="access-radio-icon">🌐</div>
                <div>
                  <div class="access-radio-title">Public</div>
                  <div class="access-radio-desc">Any node that knows the Network ID can join. Members inactive 30 days are removed but can rejoin.</div>
                </div>
              </div>
            </label>
          </div>
          <input type="hidden" id="newNetPrivate" value="true">
        </div>
      </div>

      <!-- ── Managed Routes ── -->
      <div class="cfg-section">
        <div class="cfg-section-label">Managed Routes <span style="font-size:9px;font-weight:400;color:#6a9ab8">(optional)</span></div>
        <div class="card">
          <div class="field-hint" style="margin-bottom:12px">IPv4 routes published to all members. Leave empty if you only need auto-assigned IPs without explicit routing.</div>
          <div id="newRouteList"></div>
          <div class="add-sub-card">
            <div class="add-sub-title">Add Route</div>
            <div class="range-row" style="margin-bottom:8px">
              <div style="flex:1.6;min-width:0">
                <div class="sub-field-label">DESTINATION (CIDR)</div>
                <input class="form-input" id="newRouteTarget" placeholder="e.g. 192.168.192.0/24" autocomplete="off" spellcheck="false">
              </div>
              <span class="range-sep" style="margin-top:20px">→</span>
              <div style="flex:1;min-width:0">
                <div class="sub-field-label">VIA <span style="color:#4a7a9a">(optional)</span></div>
                <input class="form-input" id="newRouteVia" placeholder="Gateway or blank" autocomplete="off" spellcheck="false">
              </div>
              <button class="btn btn-primary btn-sm" style="flex-shrink:0;margin-top:20px" onclick="addNewRoute()">Add</button>
            </div>
            <div class="field-hint">Leave <em>Via</em> blank for a direct/LAN route. <code>0.0.0.0/0</code> requires client opt-in.</div>
          </div>
        </div>
      </div>

      <!-- ── IPv4 Auto-Assign ── -->
      <div class="cfg-section">
        <div class="cfg-section-label">IPv4 Auto-Assign</div>
        <div class="card">
          <div class="toggle-row" style="margin-bottom:16px">
            <label class="toggle">
              <input type="checkbox" id="newV4Auto" checked onchange="onNewV4AutoChange()">
              <div class="toggle-track"><div class="toggle-thumb"></div></div>
            </label>
            <span style="font-size:13px;color:var(--text)">Auto-Assign from Range</span>
          </div>
          <div id="newV4AutoSection">
            <div class="tab-bar" id="newV4TabBar" style="margin-bottom:14px">
              <div class="tab active" onclick="selectNewV4Tab(this,'easy')">Easy</div>
              <div class="tab" onclick="selectNewV4Tab(this,'advanced')">Advanced</div>
            </div>
            <div id="newV4TabEasy">
              <div class="field-hint" style="margin-bottom:12px">Click a range to use it as your assignment pool.</div>
              <div class="ip-range-grid" id="newIpRangeGrid"></div>
            </div>
            <div id="newV4TabAdvanced" style="display:none">
              <div class="field-hint" style="margin-bottom:10px">Define custom start/end ranges for IP auto-assignment.</div>
              <div id="newPoolList"></div>
              <div class="add-sub-card" style="margin-top:8px">
                <div class="add-sub-title">Add IPv4 Pool Range</div>
                <div class="range-row">
                  <div style="flex:1;min-width:0">
                    <div class="sub-field-label">RANGE START</div>
                    <input class="form-input" id="newPoolStart" placeholder="e.g. 192.168.192.1" autocomplete="off">
                  </div>
                  <span class="range-sep" style="margin-top:20px">—</span>
                  <div style="flex:1;min-width:0">
                    <div class="sub-field-label">RANGE END</div>
                    <input class="form-input" id="newPoolEnd" placeholder="e.g. 192.168.192.254" autocomplete="off">
                  </div>
                  <button class="btn btn-primary btn-sm" style="flex-shrink:0;margin-top:20px" onclick="addNewPool()">Add</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── IPv6 Auto-Assign ── -->
      <div class="cfg-section">
        <div class="cfg-section-label">IPv6 Auto-Assign <span class="v6-badge" style="margin-left:6px">optional</span></div>
        <div class="card">
          <div class="toggle-row">
            <label class="toggle">
              <input type="checkbox" id="newV6Rfc" onchange="onNewV6Change()">
              <div class="toggle-track"><div class="toggle-thumb"></div></div>
            </label>
            <div>
              <div style="font-size:13px;color:var(--text)">ZeroTier RFC4193 <span class="v6-badge" style="margin-left:4px">/128</span></div>
              <div class="field-hint" style="margin-top:2px">Unique private /128 per device derived from Network ID. Best for most setups.</div>
            </div>
          </div>
          <div class="divider" style="margin:12px 0"></div>
          <div class="toggle-row">
            <label class="toggle">
              <input type="checkbox" id="newV66plane" onchange="onNewV6Change()">
              <div class="toggle-track"><div class="toggle-thumb"></div></div>
            </label>
            <div>
              <div style="font-size:13px;color:var(--text)">ZeroTier 6PLANE <span class="v6-badge" style="margin-left:4px">/80</span></div>
              <div class="field-hint" style="margin-top:2px">NDP proxy emulation — routable /80 prefix per device for full L3 IPv6 routing.</div>
            </div>
          </div>
          <div class="divider" style="margin:12px 0"></div>
          <div class="toggle-row" style="margin-bottom:0">
            <label class="toggle">
              <input type="checkbox" id="newV6Zt" onchange="onNewV6Change()">
              <div class="toggle-track"><div class="toggle-thumb"></div></div>
            </label>
            <div>
              <div style="font-size:13px;color:var(--text)">Auto-Assign from Range</div>
              <div class="field-hint" style="margin-top:2px">Assign IPv6 from manually defined pool ranges.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── Exit Node ── -->
      <div class="cfg-section">
        <div class="cfg-section-label">Exit Node</div>
        <div class="card">
          <div class="toggle-row" style="margin-bottom:10px">
            <label class="toggle">
              <input type="checkbox" id="newExitNode" onchange="onExitNodeChange()">
              <div class="toggle-track"><div class="toggle-thumb"></div></div>
            </label>
            <div>
              <div style="font-size:13px;color:var(--text);font-weight:600">Enable Exit Node
                <span style="font-size:10px;font-weight:400;color:#6a9ab8;margin-left:8px">Clients → VPN → Global Network</span>
              </div>
              <div class="field-hint" style="margin-top:3px">
                This device (controller + node on the same machine) joins the newly created network and acts as the exit node.
                All member traffic is routed through this machine's WAN interface.
                Adds the <code>0.0.0.0/0</code> default route with this node's ZeroTier IP as gateway.
              </div>
            </div>
          </div>

          <div id="exitNodeSection" style="display:none">
            <div class="notice warn" style="margin-bottom:12px">
              <span class="notice-icon">⚠</span>
              <div>
                <strong>Requires Backend API.</strong> Full automation — joining the network, enabling IP forwarding, configuring
                NAT/iptables — requires a backend service running on the controller machine.
                The API specification and manual commands are shown below after creation.
              </div>
            </div>
            <div class="form-group mb-0">
              <label class="lbl">Gateway IP hint <span style="color:#4a7a9a;font-weight:400">(optional — auto-detected from pool)</span></label>
              <input class="form-input" id="newExitGatewayIp" placeholder="e.g. 192.168.192.1  (leave blank to use pool start)" autocomplete="off" spellcheck="false">
              <div class="field-hint">The ZeroTier IP this node will receive. Used as <code>via</code> in the <code>0.0.0.0/0</code> route. If blank, the first IP in the pool is used.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── Create button ── -->
      <div class="flex gap-8" style="flex-wrap:wrap;margin-bottom:4px">
        <button class="btn btn-primary" id="createNetBtn" onclick="createNetwork()">⊕ Create Network</button>
      </div>
      <div id="createResult" class="resp" style="margin-top:14px;display:none"></div>

      <!-- ── Post-creation: Exit Node Setup ── -->
      <div id="exitNodeSetup" style="display:none;margin-top:20px">

        <!-- Backend API Spec -->
        <div class="cfg-section">
          <div class="cfg-section-label" style="color:var(--yellow)">⚠ Backend API Required — Specification</div>
          <div class="card" style="border-color:rgba(255,204,0,0.2)">
            <div style="font-size:11px;color:#90b8d0;line-height:1.8;margin-bottom:14px">
              The following operations <strong>cannot be performed via the ZeroTier Controller API alone</strong> — they require
              OS-level commands (iptables, sysctl) executed on the controller machine.
              A backend HTTP service must be implemented and running on the same host.
            </div>

            <div class="terminal" style="margin-bottom:14px">
              <div class="terminal-hdr">
                <div class="term-dot" style="background:#ff5f57"></div>
                <div class="term-dot" style="background:#ffbd2e"></div>
                <div class="term-dot" style="background:#28c840"></div>
                <span class="term-title">Backend API Spec — POST /api/exit-node/setup</span>
                <button class="btn btn-ghost btn-sm" style="margin-left:auto;font-size:10px" onclick="copyEl('backendApiSpec')">⎘ Copy</button>
              </div>
              <div class="terminal-body" id="backendApiSpec" style="max-height:380px"></div>
            </div>

            <div style="font-size:10px;color:#6a9ab8;line-height:1.8">
              <strong style="color:#90b8d0">Backend must perform:</strong><br>
              1. <code>zerotier-cli join {nwid}</code> — join the network on this machine<br>
              2. Authorize the local node via ZT Controller API: <code>POST /controller/network/{nwid}/member/{nodeId}</code> <code>{"authorized":true}</code><br>
              3. <code>sysctl -w net.ipv4.ip_forward=1</code> + persist to <code>/etc/sysctl.conf</code><br>
              4. <code>iptables -t nat -A POSTROUTING -o {WAN_IF} -j MASQUERADE</code><br>
              5. <code>iptables -A FORWARD -i {ZT_IF} -o {WAN_IF} -j ACCEPT</code><br>
              6. <code>netfilter-persistent save</code>
            </div>
          </div>
        </div>

        <!-- Manual fallback commands -->
        <div class="cfg-section">
          <div class="cfg-section-label">Manual Setup Commands <span style="font-size:9px;font-weight:400;color:#6a9ab8">(run on this machine if no backend)</span></div>
          <div class="card">
            <div class="terminal">
              <div class="terminal-hdr">
                <div class="term-dot" style="background:#ff5f57"></div>
                <div class="term-dot" style="background:#ffbd2e"></div>
                <div class="term-dot" style="background:#28c840"></div>
                <span class="term-title">bash — exit node manual configuration</span>
                <button class="btn btn-ghost btn-sm" style="margin-left:auto;font-size:10px" onclick="copyEl('exitNodeCmds')">⎘ Copy</button>
              </div>
              <div class="terminal-body" id="exitNodeCmds" style="max-height:360px"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ════════════════ NETWORK CONFIG ════════════════ -->
    <div class="panel" id="panel-network-config">
      <div class="page-hdr">
        <div>
          <div class="page-title">Configure Network</div>
          <div class="page-sub">GET/POST /controller/network/{nwid}</div>
        </div>
        <div class="page-actions">
          <button class="btn btn-ghost btn-sm" onclick="loadNetworkConfig()">↻ Reload</button>
        </div>
      </div>

      <!-- Network selector -->
      <div class="card">
        <div class="card-title" style="margin-bottom:12px"><span class="ic">⬢</span> Select Network</div>
        <div class="flex gap-8" style="flex-wrap:wrap">
          <input class="form-input" id="configNwid" placeholder="Network ID (16 hex chars)" style="flex:1;min-width:200px" autocomplete="off" spellcheck="false">
          <button class="btn btn-ghost" onclick="loadNetworkConfig()">↓ Load Config</button>
          <button class="btn btn-ghost" onclick="openNetworkPicker('configNwid', loadNetworkConfig)">≡ Pick</button>
        </div>
      </div>

      <div id="networkConfigForm" style="display:none">

        <!-- ── Section: Name & Description ── -->
        <div class="cfg-section">
          <div class="cfg-section-label">Basics</div>
          <div class="card">
            <div class="form-row">
              <div class="form-group mb-0">
                <label class="lbl">Name</label>
                <input class="form-input" id="cfgName" placeholder="e.g. home.lab or work.vpn" autocomplete="off">
                <div class="field-hint">Short human-readable name visible to all members.</div>
              </div>
              <div class="form-group mb-0">
                <label class="lbl">Description</label>
                <input class="form-input" id="cfgDesc" placeholder="Optional longer description" autocomplete="off">
                <div class="field-hint">Not sent to members — stored on controller only.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ── Section: Access Control ── -->
        <div class="cfg-section">
          <div class="cfg-section-label">Access Control</div>
          <div class="card">
            <div class="access-radio-group">
              <label class="access-radio" id="acl-private">
                <input type="radio" name="cfgAccess" value="true" id="aclPrivate" onchange="setPrivate(true)">
                <div class="access-radio-body">
                  <div class="access-radio-icon">🔒</div>
                  <div>
                    <div class="access-radio-title">Private</div>
                    <div class="access-radio-desc">Nodes must be authorized to become members. Unauthorized nodes can see the network but cannot join. Recommended for all real networks.</div>
                  </div>
                </div>
              </label>
              <label class="access-radio" id="acl-public">
                <input type="radio" name="cfgAccess" value="false" id="aclPublic" onchange="setPrivate(false)">
                <div class="access-radio-body">
                  <div class="access-radio-icon">🌐</div>
                  <div>
                    <div class="access-radio-title">Public</div>
                    <div class="access-radio-desc">Any node that knows the Network ID can join. Members cannot be de-authorized or deleted. Members inactive for 30 days are removed automatically but can rejoin.</div>
                  </div>
                </div>
              </label>
            </div>
            <!-- hidden field for save logic -->
            <input type="hidden" id="cfgPrivate" value="true">
          </div>
        </div>

        <!-- ── Section: Managed Routes ── -->
        <div class="cfg-section">
          <div class="cfg-section-label">Managed Routes</div>
          <div class="card">
            <div class="field-hint" style="margin-bottom:12px">
              IPv4 and IPv6 routes published to all members. Use to route traffic to other subnets via a gateway on this network.
              Routes overlapping public IP space are marked <span class="badge b-yellow" style="font-size:9px">⚠ public</span> — clients must explicitly allow these.
            </div>
            <div id="routeList"></div>

            <!-- Add route form -->
            <div class="add-sub-card">
              <div class="add-sub-title">Add Route</div>
              <div class="range-row" style="margin-bottom:8px">
                <div style="flex:1.6;min-width:0">
                  <div class="sub-field-label">DESTINATION (CIDR)</div>
                  <input class="form-input" id="routeTarget" placeholder="e.g. 192.168.1.0/24 or 0.0.0.0/0" autocomplete="off" spellcheck="false">
                </div>
                <span class="range-sep" style="margin-top:20px">→</span>
                <div style="flex:1;min-width:0">
                  <div class="sub-field-label">VIA <span style="color:#4a7a9a">(optional)</span></div>
                  <input class="form-input" id="routeVia" placeholder="Gateway IP or leave blank" autocomplete="off" spellcheck="false">
                </div>
                <button class="btn btn-primary btn-sm" style="flex-shrink:0;margin-top:20px" onclick="addRoute()">Submit</button>
              </div>
              <div class="field-hint">Leave <em>Via</em> blank for a direct/LAN route (null). Default route <code>0.0.0.0/0</code> requires client opt-in.</div>
            </div>
          </div>
        </div>

        <!-- ── Section: IPv4 Auto-Assign ── -->
        <div class="cfg-section">
          <div class="cfg-section-label">IPv4 Auto-Assign</div>
          <div class="card">

            <!-- Toggle -->
            <div class="toggle-row" style="margin-bottom:16px">
              <label class="toggle">
                <input type="checkbox" id="cfgV4Auto" onchange="onV4AutoChange()">
                <div class="toggle-track"><div class="toggle-thumb"></div></div>
              </label>
              <span style="font-size:13px;color:var(--text)">Auto-Assign from Range</span>
              <input type="hidden" id="cfgV4Mode" value="zt">
            </div>

            <div id="v4AutoSection">
              <!-- Easy: predefined ranges -->
              <div class="tab-bar" id="v4TabBar" style="margin-bottom:14px">
                <div class="tab active" onclick="selectV4Tab(this,'easy')">Easy</div>
                <div class="tab" onclick="selectV4Tab(this,'advanced')">Advanced</div>
              </div>

              <!-- Easy tab -->
              <div id="v4TabEasy">
                <div class="field-hint" style="margin-bottom:12px">Click a range to use it as your assignment pool.</div>
                <div class="ip-range-grid" id="ipRangeGrid"></div>
              </div>

              <!-- Advanced tab -->
              <div id="v4TabAdvanced" style="display:none">
                <div class="field-hint" style="margin-bottom:10px">Define custom start/end ranges for IP auto-assignment.</div>
                <div id="poolList"></div>
                <div class="add-sub-card" style="margin-top:8px">
                  <div class="add-sub-title">Add IPv4 Pool Range</div>
                  <div class="range-row">
                    <div style="flex:1;min-width:0">
                      <div class="sub-field-label">RANGE START</div>
                      <input class="form-input" id="poolStart" placeholder="e.g. 192.168.168.1" autocomplete="off">
                    </div>
                    <span class="range-sep" style="margin-top:20px">—</span>
                    <div style="flex:1;min-width:0">
                      <div class="sub-field-label">RANGE END</div>
                      <input class="form-input" id="poolEnd" placeholder="e.g. 192.168.168.254" autocomplete="off">
                    </div>
                    <button class="btn btn-primary btn-sm" style="flex-shrink:0;margin-top:20px" onclick="addPool()">Add Pool</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ── Section: IPv6 Auto-Assign ── -->
        <div class="cfg-section">
          <div class="cfg-section-label">IPv6 Auto-Assign</div>
          <div class="card">
            <!-- Hidden inputs -->
            <input type="hidden" id="cfgV6rfc"    value="false">
            <input type="hidden" id="cfgV66plane" value="false">
            <input type="hidden" id="cfgV6zt"     value="false">
            <input type="hidden" id="cfgV6Mode"   value="none">

            <!-- rfc4193 toggle -->
            <div class="toggle-row">
              <label class="toggle">
                <input type="checkbox" id="v6ChkRfc" onchange="onV6Check('rfc4193',this.checked)">
                <div class="toggle-track"><div class="toggle-thumb"></div></div>
              </label>
              <div>
                <div style="font-size:13px;color:var(--text)">ZeroTier RFC4193 <span class="v6-badge" style="margin-left:4px">/128</span></div>
                <div class="field-hint" style="margin-top:2px">Assigns each device a unique private /128 IPv6 address derived from Network ID. No pool needed. Best for most setups.</div>
              </div>
            </div>
            <div class="divider" style="margin:12px 0"></div>

            <!-- 6plane toggle -->
            <div class="toggle-row">
              <label class="toggle">
                <input type="checkbox" id="v6Chk6plane" onchange="onV6Check('6plane',this.checked)">
                <div class="toggle-track"><div class="toggle-thumb"></div></div>
              </label>
              <div>
                <div style="font-size:13px;color:var(--text)">ZeroTier 6PLANE <span class="v6-badge" style="margin-left:4px">/80</span></div>
                <div class="field-hint" style="margin-top:2px">NDP proxy emulation. Assigns a routable /80 prefix per device for full L3 IPv6 routing between nodes.</div>
              </div>
            </div>
            <div class="divider" style="margin:12px 0"></div>

            <!-- zt pool toggle -->
            <div class="toggle-row" style="margin-bottom:0">
              <label class="toggle">
                <input type="checkbox" id="v6ChkZt" onchange="onV6Check('zt',this.checked)">
                <div class="toggle-track"><div class="toggle-thumb"></div></div>
              </label>
              <div style="flex:1">
                <div style="font-size:13px;color:var(--text)">Auto-Assign from Range</div>
                <div class="field-hint" style="margin-top:2px">Assigns IPv6 addresses from manually defined pool ranges, like IPv4 auto-assign.</div>
              </div>
            </div>

            <!-- IPv6 pool sub-section (shown when zt is on) -->
            <div id="v6PoolSection" style="display:none;margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
              <div id="v6PoolList"></div>
              <div class="add-sub-card" style="margin-top:8px">
                <div class="add-sub-title">Add IPv6 Pool Range</div>
                <div class="range-row">
                  <div style="flex:1;min-width:0">
                    <div class="sub-field-label">RANGE START</div>
                    <input class="form-input" id="v6poolStart" placeholder="e.g. 2001:db8::1" autocomplete="off" spellcheck="false">
                  </div>
                  <span class="range-sep" style="margin-top:20px">—</span>
                  <div style="flex:1;min-width:0">
                    <div class="sub-field-label">RANGE END</div>
                    <input class="form-input" id="v6poolEnd" placeholder="e.g. 2001:db8::ffff" autocomplete="off" spellcheck="false">
                  </div>
                  <button class="btn btn-primary btn-sm" style="flex-shrink:0;margin-top:20px" onclick="addV6Pool()">Add Pool</button>
                </div>
              </div>
            </div>

            <!-- IPv6 routes sub-section (shown when 6plane or zt is on) -->
            <div id="v6RouteSection" style="display:none;margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
              <div style="font-size:11px;font-weight:600;color:#90b8d0;margin-bottom:8px">IPv6 Routes</div>
              <div id="v6RouteList"></div>
              <div class="add-sub-card" style="margin-top:8px">
                <div class="add-sub-title">Add IPv6 Route</div>
                <div class="range-row">
                  <div style="flex:1.6;min-width:0">
                    <div class="sub-field-label">DESTINATION (CIDR)</div>
                    <input class="form-input" id="v6routeTarget" placeholder="e.g. ::/0 or 2001:db8::/48" autocomplete="off" spellcheck="false">
                  </div>
                  <span class="range-sep" style="font-size:10px;margin-top:20px">via</span>
                  <div style="flex:1;min-width:0">
                    <div class="sub-field-label">VIA <span style="color:#4a7a9a">(optional)</span></div>
                    <input class="form-input" id="v6routeVia" placeholder="Gateway or blank" autocomplete="off" spellcheck="false">
                  </div>
                  <button class="btn btn-primary btn-sm" style="flex-shrink:0;margin-top:20px" onclick="addV6Route()">Submit</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ── Section: Multicast & Broadcast ── -->
        <div class="cfg-section">
          <div class="cfg-section-label">Multicast</div>
          <div class="card">
            <div class="form-row">
              <div class="form-group">
                <label class="lbl">Multicast Recipient Limit</label>
                <input class="form-input" id="cfgMcLimit" type="number" min="0" style="max-width:120px">
                <div class="field-hint">Max nodes receiving a single multicast/broadcast. 0 = multicast disabled. Default: 32.</div>
              </div>
              <div class="form-group">
                <label class="lbl">Broadcast</label>
                <div class="toggle-row" style="margin-top:6px">
                  <label class="toggle">
                    <input type="checkbox" id="cfgBroadcastChk" onchange="setVal('cfgBroadcast',this.checked?'true':'false')">
                    <div class="toggle-track"><div class="toggle-thumb"></div></div>
                  </label>
                  <span style="font-size:12px;color:var(--text)">Enable Broadcast</span>
                </div>
                <input type="hidden" id="cfgBroadcast" value="true">
                <div class="field-hint" style="margin-top:6px">Allow Ethernet broadcast (ff:ff:ff:ff:ff:ff) on this network.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ── Section: DNS ── -->
        <div class="cfg-section">
          <div class="cfg-section-label">DNS <span style="font-size:9px;color:#6a9ab8;font-weight:400;margin-left:4px">requires ZeroTier ≥ 1.6</span></div>
          <div class="card">
            <div class="form-row">
              <div class="form-group">
                <label class="lbl">Search Domain</label>
                <input class="form-input" id="cfgDnsDomain" placeholder="e.g. ztnet.local" autocomplete="off" spellcheck="false">
                <div class="field-hint">Pushed to members as a DNS search domain.</div>
              </div>
              <div class="form-group">
                <label class="lbl">Add Server Address</label>
                <div class="range-row">
                  <input class="form-input" id="cfgDnsInput" placeholder="e.g. 10.147.20.190" autocomplete="off">
                  <button class="btn btn-primary btn-sm" style="flex-shrink:0" onclick="addDnsServer()">Submit</button>
                </div>
              </div>
            </div>
            <div id="dnsList" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- ── Save / Delete ── -->
        <div class="flex gap-8" style="flex-wrap:wrap;margin-top:4px">
          <button class="btn btn-primary" id="saveNetBtn" onclick="saveNetworkConfig()">✓ Save Changes</button>
          <button class="btn btn-danger" onclick="deleteNetwork()">⊗ Delete Network</button>
        </div>
        <div id="configResult" class="resp" style="margin-top:14px;display:none"></div>

      </div>
    </div>

    <!-- ════════════════ MEMBERS ════════════════ -->
    <div class="panel" id="panel-members">
      <div class="page-hdr">
        <div>
          <div class="page-title">Members</div>
          <div class="page-sub">GET /controller/network/{nwid}/member</div>
        </div>
        <div class="page-actions">
          <button class="btn btn-ghost btn-sm" onclick="loadMembers()">↻ Refresh</button>
        </div>
      </div>

      <div class="card mb-14">
        <div class="flex gap-8 items-ctr" style="flex-wrap:wrap">
          <input class="form-input" id="membersNwid" placeholder="Network ID" style="flex:1;min-width:200px" autocomplete="off">
          <button class="btn btn-ghost" onclick="loadMembers()">Load Members</button>
          <button class="btn btn-ghost" onclick="openNetworkPicker('membersNwid', loadMembers)">≡ Pick</button>
        </div>
      </div>

      <!-- Mobile member cards -->
      <div id="membersMobileList" class="hidden"></div>

      <!-- Desktop table -->
      <div class="card desk-only">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Member ID</th>
                <th>Name</th>
                <th>IP Assignments</th>
                <th class="tbl-hide-mob">Version</th>
                <th>Authorized</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="membersTable">
              <tr><td colspan="6"><div class="empty">Enter a Network ID and click Load Members</div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ════════════════ MEMBER DETAIL ════════════════ -->
    <div class="panel" id="panel-member-detail">
      <div class="page-hdr">
        <div>
          <div class="page-title">Member Detail</div>
          <div class="page-sub">GET/POST /controller/network/{nwid}/member/{memid}</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom:12px"><span class="ic">◐</span> Lookup Member</div>
        <div class="flex gap-8" style="flex-wrap:wrap">
          <input class="form-input" id="detailNwid" placeholder="Network ID" style="flex:1;min-width:160px" autocomplete="off">
          <input class="form-input" id="detailMemid" placeholder="Member Node ID" style="flex:1;min-width:140px" autocomplete="off">
          <button class="btn btn-ghost" onclick="loadMemberDetail()">↓ Load</button>
        </div>
      </div>

      <div id="memberDetailPanel" style="display:none">
        <div class="card">
          <div class="card-title" style="margin-bottom:16px"><span class="ic">⚙</span> Member Settings</div>
          <div class="form-row">
            <div class="form-group">
              <label class="lbl">Node ID</label>
              <input class="form-input" id="memId" readonly>
            </div>
            <div class="form-group">
              <label class="lbl">Name / Description</label>
              <input class="form-input" id="memName" autocomplete="off">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="lbl">Authorization Status</label>
              <select class="form-select" id="memAuth">
                <option value="true">✓ Authorized</option>
                <option value="false">✕ Not Authorized</option>
              </select>
            </div>
            <div class="form-group">
              <label class="lbl">Active Bridge</label>
              <select class="form-select" id="memBridge">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="lbl">Managed IP Assignments</label>
            <div class="tag-box" id="memIpTags"></div>
            <div class="flex gap-8 mt-12">
              <input class="form-input" id="memIpInput" placeholder="e.g. 192.168.192.10" style="flex:1">
              <button class="btn btn-ghost btn-sm" onclick="addMemberIp()">⊕ Add IP</button>
            </div>
          </div>
          <div class="form-group">
            <label class="lbl">Capabilities (space-separated IDs)</label>
            <input class="form-input" id="memCapabilities" placeholder="e.g. 1000 2000">
          </div>
          <div class="form-group mb-0">
            <label class="lbl">Tags (ID=Value pairs, space-separated)</label>
            <input class="form-input" id="memTags" placeholder="e.g. 1000=100">
          </div>
        </div>

        <div class="flex gap-8" style="flex-wrap:wrap">
          <button class="btn btn-primary" id="saveMemberBtn" onclick="saveMember()">✓ Save Member</button>
          <button class="btn btn-success btn-sm" onclick="authorizeMember(true)">✓ Authorize</button>
          <button class="btn btn-warn btn-sm" onclick="authorizeMember(false)">✕ Deauthorize</button>
          <button class="btn btn-danger btn-sm ml-auto" onclick="deleteMember()">⊗ Delete</button>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="card-hdr">
            <div class="card-title"><span class="ic">{ }</span> Raw Member Data</div>
            <button class="copy-btn" onclick="copyEl('memberRaw')">⎘ Copy</button>
          </div>
          <div class="resp" id="memberRaw"></div>
        </div>
      </div>
    </div>

    <!-- ════════════════ RAW API ════════════════ -->
    <div class="panel" id="panel-raw-api">
      <div class="page-hdr">
        <div>
          <div class="page-title">Raw API</div>
          <div class="page-sub">Direct ZeroTier Controller API access</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom:14px"><span class="ic">≺/≻</span> Request</div>
        <div class="flex gap-8 mb-14" style="flex-wrap:wrap">
          <select class="form-select" id="rawMethod" style="width:110px;flex-shrink:0">
            <option>GET</option>
            <option>POST</option>
            <option>DELETE</option>
          </select>
          <input class="form-input" id="rawPath" placeholder="/status" style="flex:1;min-width:160px" autocomplete="off" spellcheck="false">
          <button class="btn btn-primary" id="rawSendBtn" onclick="sendRawRequest()">▶ Send</button>
        </div>
        <div class="form-group">
          <label class="lbl">Body (JSON) — POST only</label>
          <textarea class="form-input" id="rawBody" rows="4" placeholder='{"key": "value"}' spellcheck="false"></textarea>
        </div>
        <div class="divider"></div>
        <div class="card-title" style="margin-bottom:10px;font-size:11px;color:#6a9ab8">QUICK SHORTCUTS</div>
        <div class="flex gap-6" style="flex-wrap:wrap">
          <button class="btn btn-ghost btn-sm" onclick="qApi('GET','/status')">GET /status</button>
          <button class="btn btn-ghost btn-sm" onclick="qApi('GET','/controller/network')">GET networks</button>
          <button class="btn btn-ghost btn-sm" onclick="qApiNet()">GET network/{id}</button>
          <button class="btn btn-ghost btn-sm" onclick="qApiMem()">GET members</button>
          <button class="btn btn-ghost btn-sm" onclick="qApi('GET','/controller')">GET /controller</button>
        </div>
      </div>

      <div class="card">
        <div class="card-hdr">
          <div class="card-title"><span class="ic">→</span> Response</div>
          <div class="flex gap-6">
            <span id="rawStatus" style="font-size:10px;color:#6a9ab8"></span>
            <button class="copy-btn" onclick="copyEl('rawResponse')">⎘ Copy</button>
          </div>
        </div>
        <div class="resp" id="rawResponse">Send a request to see the response here.</div>
      </div>
    </div>

    <!-- ════════════════ CURL BUILDER ════════════════ -->
    <div class="panel" id="panel-terminal">
      <div class="page-hdr">
        <div>
          <div class="page-title">cURL Builder</div>
          <div class="page-sub">Generate ready-to-paste shell commands</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom:14px"><span class="ic">◧</span> Variables</div>
        <div class="form-row">
          <div class="form-group">
            <label class="lbl">Host</label>
            <input class="form-input" id="curlHost" placeholder="http://localhost:9993" autocomplete="off">
          </div>
          <div class="form-group">
            <label class="lbl">Auth Token</label>
            <input class="form-input" id="curlToken" placeholder="your-auth-token" autocomplete="off">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="lbl">Node ID</label>
            <input class="form-input" id="curlNodeId" placeholder="10-char hex node id" autocomplete="off">
          </div>
          <div class="form-group">
            <label class="lbl">Network ID</label>
            <input class="form-input" id="curlNwid" placeholder="16-char network id" autocomplete="off">
          </div>
        </div>
        <div class="form-group mb-0">
          <label class="lbl">Member ID</label>
          <input class="form-input" id="curlMemId" placeholder="10-char member node id" autocomplete="off" style="max-width:240px">
        </div>
        <button class="btn btn-ghost btn-sm mt-12" onclick="syncCurlVars()">⟳ Sync from Connection</button>
      </div>

      <div class="tab-bar" id="curlTabBar">
        <div class="tab active"    onclick="selectCurlTab(this,'curl-status')">Status</div>
        <div class="tab"           onclick="selectCurlTab(this,'curl-list-nets')">List Nets</div>
        <div class="tab"           onclick="selectCurlTab(this,'curl-create-net')">Create Net</div>
        <div class="tab"           onclick="selectCurlTab(this,'curl-get-net')">Get Net</div>
        <div class="tab"           onclick="selectCurlTab(this,'curl-config-net')">Config Net</div>
        <div class="tab"           onclick="selectCurlTab(this,'curl-list-mem')">List Members</div>
        <div class="tab"           onclick="selectCurlTab(this,'curl-auth-mem')">Auth Member</div>
        <div class="tab"           onclick="selectCurlTab(this,'curl-del-mem')">Delete Member</div>
      </div>

      <div class="terminal">
        <div class="terminal-hdr">
          <div class="term-dot" style="background:#ff5f57"></div>
          <div class="term-dot" style="background:#ffbd2e"></div>
          <div class="term-dot" style="background:#28c840"></div>
          <span class="term-title">bash — curl commands</span>
          <button class="copy-btn ml-auto" style="color:#6a9ab8" onclick="copyCurl()">⎘ Copy</button>
        </div>
        <div class="terminal-body" id="curlOutput"></div>
      </div>
    </div>

    <!-- ════════════════ SETTINGS ════════════════ -->
    <div class="panel" id="panel-settings">
      <div class="page-hdr">
        <div>
          <div class="page-title">Connection Settings</div>
          <div class="page-sub">Configure API endpoint and authentication</div>
        </div>
      </div>

      <div class="notice warn">
        <span class="notice-icon">⚠</span>
        <div>This UI communicates directly with your local ZeroTier controller via the browser. Ensure CORS is allowed, or serve this file from the same host as ZeroTier, or use a reverse proxy. Settings are saved to localStorage.</div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom:16px"><span class="ic">◧</span> Controller Endpoint</div>
        <div class="form-group">
          <label class="lbl">API Host URL</label>
          <input class="form-input" id="settingsHost" placeholder="http://localhost:9993" autocomplete="off">
          <div style="margin-top:6px;font-size:10px;color:#6a9ab8">Default: <code style="color:var(--accent)">http://localhost:9993</code> — the ZeroTier daemon's local API</div>
        </div>
        <div class="form-group">
          <label class="lbl">Auth Token (X-ZT1-AUTH)</label>
          <input class="form-input" id="settingsToken" type="password" autocomplete="off">
          <div style="margin-top:6px;font-size:10px;color:#6a9ab8">
            Linux: <code style="color:var(--accent)">/var/lib/zerotier-one/authtoken.secret</code><br>
            macOS: <code style="color:var(--accent)">/Library/Application Support/ZeroTier/One/authtoken.secret</code><br>
            Windows: <code style="color:var(--accent)">C:\ProgramData\ZeroTier\One\authtoken.secret</code>
          </div>
        </div>
        <div class="flex gap-8">
          <button class="btn btn-primary" onclick="applySettings()">✓ Apply &amp; Connect</button>
          <button class="btn btn-ghost" onclick="clearSettings()">✕ Clear</button>
        </div>
        <div id="settingsStatus" style="margin-top:12px;font-size:11px;color:#6a9ab8"></div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom:14px"><span class="ic">$_</span> Quick Setup Commands</div>
        <div class="terminal">
          <div class="terminal-hdr">
            <div class="term-dot" style="background:#ff5f57"></div>
            <div class="term-dot" style="background:#ffbd2e"></div>
            <div class="term-dot" style="background:#28c840"></div>
            <span class="term-title">bash</span>
          </div>
          <div class="terminal-body">
<span class="c"># ── Read auth token ────────────────────────</span>
<span class="c"># Linux</span>
<span class="p">$</span> <span class="cmd">sudo cat /var/lib/zerotier-one/authtoken.secret</span>

<span class="c"># macOS</span>
<span class="p">$</span> <span class="cmd">sudo cat "/Library/Application Support/ZeroTier/One/authtoken.secret"</span>

<span class="c"># ── Get your Node ID ───────────────────────</span>
<span class="p">$</span> <span class="cmd">zerotier-cli info</span>
<span class="out">200 info a1b2c3d4e5 1.14.0 ONLINE</span>

<span class="c"># ── Save to env vars ───────────────────────</span>
<span class="p">$</span> <span class="cmd">TOKEN=$(sudo cat /var/lib/zerotier-one/authtoken.secret)</span>
<span class="p">$</span> <span class="cmd">NODEID=$(zerotier-cli info | cut -d ' ' -f 3)</span>

<span class="c"># ── Test connection ────────────────────────</span>
<span class="p">$</span> <span class="cmd">curl http://localhost:9993/status -H "X-ZT1-AUTH: $TOKEN"</span></div>
        </div>
      </div>

      <!-- REVERSE TUNNEL SECTION -->
      <div class="card">
        <div class="card-hdr" style="margin-bottom:4px">
          <div class="card-title"><span class="ic">⇄</span> Remote Access via Reverse Tunnel</div>
        </div>
        <div style="font-size:11px;color:#6a9ab8;margin-bottom:16px;line-height:1.7">
          The ZeroTier Controller API listens only on <code style="color:var(--accent)">localhost:9993</code> and has no built-in remote access. To manage it from another machine or browser, set up a reverse tunnel and paste the resulting URL into the <em>API Host</em> field above.
        </div>

        <div class="notice warn" style="margin-bottom:16px">
          <span class="notice-icon">⚠</span>
          <div>Exposing port 9993 publicly without additional authentication is dangerous. Anyone with your token can fully control all networks. Always add an auth layer in front of the tunnel.</div>
        </div>

        <!-- SSH -->
        <div class="tunnel-block open" id="tb-ssh">
          <div class="tunnel-block-hdr" onclick="toggleTunnel('tb-ssh')">
            <div class="tunnel-block-hl">
              <span style="font-size:18px">🔐</span>
              <div>
                <div class="tunnel-block-title">SSH Remote Port Forwarding</div>
                <div class="tunnel-block-sub">Built-in, no extra software · temporary</div>
              </div>
            </div>
            <span class="tunnel-arrow">▼</span>
          </div>
          <div class="tunnel-block-body">
            <div style="font-size:11px;color:#90b8d0;margin-bottom:10px;line-height:1.7">Run on the <strong>server with ZeroTier</strong>. The remote port <code style="color:var(--accent)">9993</code> on your jump host will forward to local <code style="color:var(--accent)">localhost:9993</code>. Use <code style="color:var(--accent)">autossh</code> to keep it alive.</div>
            <div class="terminal" style="margin-bottom:10px">
              <div class="terminal-hdr"><div class="term-dot" style="background:#ff5f57"></div><div class="term-dot" style="background:#ffbd2e"></div><div class="term-dot" style="background:#28c840"></div></div>
              <div class="terminal-body" style="max-height:160px">
<span class="c"># One-shot tunnel</span>
<span class="p">$</span> <span class="cmd">ssh -N -R 9993:localhost:9993 user@your-jump-host</span>

<span class="c"># Persistent with autossh</span>
<span class="p">$</span> <span class="cmd">autossh -M 0 -N -o "ServerAliveInterval 30" \
  -R 9993:localhost:9993 user@your-jump-host</span>

<span class="c"># Then in ZTNET Tools, set API Host to:</span>
<span class="out">http://your-jump-host:9993</span></div>
            </div>
            <div class="flex gap-6" style="flex-wrap:wrap">
              <span class="tunnel-chip">✓ No extra install</span>
              <span class="tunnel-chip">✓ Encrypted (SSH)</span>
              <span class="tunnel-chip">⚠ Requires jump host</span>
              <span class="tunnel-chip">⚠ Needs GatewayPorts yes in sshd_config</span>
            </div>
          </div>
        </div>

        <!-- Cloudflare -->
        <div class="tunnel-block" id="tb-cf">
          <div class="tunnel-block-hdr" onclick="toggleTunnel('tb-cf')">
            <div class="tunnel-block-hl">
              <span style="font-size:18px">🌐</span>
              <div>
                <div class="tunnel-block-title">Cloudflare Tunnel (cloudflared)</div>
                <div class="tunnel-block-sub">No open ports · HTTPS · free tier available</div>
              </div>
            </div>
            <span class="tunnel-arrow">▼</span>
          </div>
          <div class="tunnel-block-body">
            <div style="font-size:11px;color:#90b8d0;margin-bottom:10px;line-height:1.7">Install <code style="color:var(--accent)">cloudflared</code> on the ZeroTier server. Cloudflare creates a secure outbound-only tunnel — no port forwarding needed. Add <strong>Zero Trust Access</strong> policy to protect the endpoint with email/SSO auth.</div>
            <div class="terminal" style="margin-bottom:10px">
              <div class="terminal-hdr"><div class="term-dot" style="background:#ff5f57"></div><div class="term-dot" style="background:#ffbd2e"></div><div class="term-dot" style="background:#28c840"></div></div>
              <div class="terminal-body" style="max-height:200px">
<span class="c"># Install cloudflared (Debian/Ubuntu)</span>
<span class="p">$</span> <span class="cmd">curl -L https://pkg.cloudflare.com/cloudflare-main.gpg | sudo apt-key add -
echo "deb https://pkg.cloudflare.com/ $(lsb_release -cs) main" | \
  sudo tee /etc/apt/sources.list.d/cloudflare.list
sudo apt update &amp;&amp; sudo apt install cloudflared</span>

<span class="c"># Quick temporary tunnel (no account needed)</span>
<span class="p">$</span> <span class="cmd">cloudflared tunnel --url http://localhost:9993</span>
<span class="out">https://random-words.trycloudflare.com  ← paste this as API Host</span>

<span class="c"># Named tunnel with custom domain (requires account)</span>
<span class="p">$</span> <span class="cmd">cloudflared tunnel create ztnet
cloudflared tunnel route dns ztnet ztnet.yourdomain.com
cloudflared tunnel run ztnet</span></div>
            </div>
            <div class="flex gap-6" style="flex-wrap:wrap">
              <span class="tunnel-chip">✓ No firewall rules needed</span>
              <span class="tunnel-chip">✓ Free HTTPS cert</span>
              <span class="tunnel-chip">✓ Access policies available</span>
              <span class="tunnel-chip">⚠ Cloudflare sees traffic</span>
            </div>
          </div>
        </div>

        <!-- ngrok -->
        <div class="tunnel-block" id="tb-ngrok">
          <div class="tunnel-block-hdr" onclick="toggleTunnel('tb-ngrok')">
            <div class="tunnel-block-hl">
              <span style="font-size:18px">⚡</span>
              <div>
                <div class="tunnel-block-title">ngrok</div>
                <div class="tunnel-block-sub">Fast setup · free tier with random URLs</div>
              </div>
            </div>
            <span class="tunnel-arrow">▼</span>
          </div>
          <div class="tunnel-block-body">
            <div style="font-size:11px;color:#90b8d0;margin-bottom:10px;line-height:1.7">Create a free account at <code style="color:var(--accent)">ngrok.com</code>, install the agent, authenticate, then expose port 9993. Free tier gives a random HTTPS URL that changes on restart; paid plans allow fixed domains.</div>
            <div class="terminal" style="margin-bottom:10px">
              <div class="terminal-hdr"><div class="term-dot" style="background:#ff5f57"></div><div class="term-dot" style="background:#ffbd2e"></div><div class="term-dot" style="background:#28c840"></div></div>
              <div class="terminal-body" style="max-height:140px">
<span class="c"># Authenticate once</span>
<span class="p">$</span> <span class="cmd">ngrok config add-authtoken YOUR_NGROK_TOKEN</span>

<span class="c"># Start tunnel</span>
<span class="p">$</span> <span class="cmd">ngrok http 9993</span>
<span class="out">Forwarding  https://abc123.ngrok-free.app → localhost:9993</span></div>
            </div>
            <div class="flex gap-6" style="flex-wrap:wrap">
              <span class="tunnel-chip">✓ Instant setup</span>
              <span class="tunnel-chip">✓ Free HTTPS</span>
              <span class="tunnel-chip">⚠ URL changes on restart (free)</span>
              <span class="tunnel-chip">⚠ ngrok sees traffic</span>
            </div>
          </div>
        </div>

        <!-- nginx proxy -->
        <div class="tunnel-block" id="tb-nginx">
          <div class="tunnel-block-hdr" onclick="toggleTunnel('tb-nginx')">
            <div class="tunnel-block-hl">
              <span style="font-size:18px">🛡</span>
              <div>
                <div class="tunnel-block-title">nginx Reverse Proxy + Basic Auth</div>
                <div class="tunnel-block-sub">Self-hosted · full control · recommended for production</div>
              </div>
            </div>
            <span class="tunnel-arrow">▼</span>
          </div>
          <div class="tunnel-block-body">
            <div style="font-size:11px;color:#90b8d0;margin-bottom:10px;line-height:1.7">Run nginx on the same server (or a VPS), proxy to <code style="color:var(--accent)">localhost:9993</code>, add HTTP Basic Auth as a second factor, and optionally terminate TLS with Let's Encrypt. The most secure self-hosted option.</div>
            <div class="terminal" style="margin-bottom:10px">
              <div class="terminal-hdr"><div class="term-dot" style="background:#ff5f57"></div><div class="term-dot" style="background:#ffbd2e"></div><div class="term-dot" style="background:#28c840"></div></div>
              <div class="terminal-body" style="max-height:220px">
<span class="c"># /etc/nginx/sites-available/ztnet</span>
<span class="cmd">server {
  listen 443 ssl;
  server_name ztnet.yourdomain.com;

  ssl_certificate     /etc/letsencrypt/live/ztnet.yourdomain.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/ztnet.yourdomain.com/privkey.pem;

  auth_basic "ZTNet Access";
  auth_basic_user_file /etc/nginx/.htpasswd;

  location / {
    proxy_pass http://127.0.0.1:9993;
    proxy_set_header X-ZT1-AUTH $http_x_zt1_auth;
  }
}</span>

<span class="c"># Create password file</span>
<span class="p">$</span> <span class="cmd">htpasswd -c /etc/nginx/.htpasswd admin</span>

<span class="c"># Get TLS cert</span>
<span class="p">$</span> <span class="cmd">certbot --nginx -d ztnet.yourdomain.com</span></div>
            </div>
            <div class="flex gap-6" style="flex-wrap:wrap">
              <span class="tunnel-chip">✓ Full self-hosted control</span>
              <span class="tunnel-chip">✓ Double auth layer</span>
              <span class="tunnel-chip">✓ Custom domain + TLS</span>
              <span class="tunnel-chip">⚠ Requires public server</span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- ═══ MOBILE BOTTOM NAV ═══ -->
<nav id="mob-nav">
  <div class="mob-nav-item active" onclick="navigate('/')" data-page="dashboard">
    <div class="mob-nav-icon">⬡</div>
    <div class="mob-nav-lbl">Home</div>
  </div>
  <div class="mob-nav-item" onclick="navigate('/networks')" data-page="networks">
    <div class="mob-nav-icon">⬢</div>
    <div class="mob-nav-lbl">Networks</div>
    <div class="mob-nav-badge" id="mobNetBadge"></div>
  </div>
  <div class="mob-nav-item" onclick="navigate('/members')" data-page="members">
    <div class="mob-nav-icon">◎</div>
    <div class="mob-nav-lbl">Members</div>
    <div class="mob-nav-badge" id="mobMemBadge"></div>
  </div>
  <div class="mob-nav-item" onclick="navigate('/api')" data-page="raw-api">
    <div class="mob-nav-icon">≺/≻</div>
    <div class="mob-nav-lbl">API</div>
  </div>
  <div class="mob-nav-item" onclick="navigate('/settings')" data-page="settings">
    <div class="mob-nav-icon">◧</div>
    <div class="mob-nav-lbl">Settings</div>
  </div>
</nav>

<!-- FAB -->
<button id="fab" onclick="fabAction()" aria-label="Create network">＋</button>

<!-- TOAST -->
<div id="toast-wrap"></div>

<!-- NETWORK PICKER MODAL -->
<div id="pickerModal" style="display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:16px">
  <div style="background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);width:100%;max-width:480px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
      <span style="font-family:Outfit,sans-serif;font-weight:600;color:#fff;font-size:15px">Pick a Network</span>
      <button onclick="closePicker()" style="background:none;border:none;color:#6a9ab8;cursor:pointer;font-size:20px;padding:0;line-height:1">×</button>
    </div>
    <div style="padding:12px 16px;border-bottom:1px solid var(--border)">
      <input class="form-input" id="pickerSearch" placeholder="Filter networks..." oninput="filterPicker()">
    </div>
    <div id="pickerList" style="overflow-y:auto;padding:8px"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════════
const S = {
  host: 'http://localhost:9993',
  token: '',
  nodeId: '',
  connected: false,
  networks: [],       // array of {id, name, private, ...}
  selectedNwid: '',
  memberIps: [],
  pools: [],
  routes: [],
};

// ═══════════════════════════════════════════════════════
//  PERSISTENCE
// ═══════════════════════════════════════════════════════
function savePrefs() {
  try {
    localStorage.setItem('ztnet_host',  S.host);
    localStorage.setItem('ztnet_token', S.token);
  } catch(e){}
}
function loadPrefs() {
  try {
    const h = localStorage.getItem('ztnet_host');
    const t = localStorage.getItem('ztnet_token');
    if (h) { S.host = h; setVal('apiHost', h); setVal('mobApiHost', h); setVal('settingsHost', h); }
    if (t) { S.token = t; setVal('apiToken', t); setVal('mobApiToken', t); setVal('settingsToken', t); }
  } catch(e){}
}

// ═══════════════════════════════════════════════════════
//  NAVIGATION
// ═══════════════════════════════════════════════════════
const ROUTES = [
  { pattern: /^\/$/, page: 'dashboard', panel: 'dashboard' },
  { pattern: /^\/status\/?$/, page: 'status', panel: 'status' },
  { pattern: /^\/networks\/?$/, page: 'networks', panel: 'networks' },
  { pattern: /^\/networks\/create\/?$/, page: 'create-network', panel: 'create-network' },
  { pattern: /^\/networks\/([^/]+)\/?$/, page: 'network-config', panel: 'network-config', params: ['nwid'] },
  { pattern: /^\/members\/?$/, page: 'members', panel: 'members' },
  { pattern: /^\/members\/([^/]+)\/([^/]+)\/?$/, page: 'member-detail', panel: 'member-detail', params: ['nwid', 'id'] },
  { pattern: /^\/api\/?$/, page: 'raw-api', panel: 'raw-api' },
  { pattern: /^\/curl\/?$/, page: 'terminal', panel: 'terminal' },
  { pattern: /^\/settings\/?$/, page: 'settings', panel: 'settings' },
];

const LEGACY_PAGE_TO_PATH = {
  dashboard: '/',
  status: '/status',
  networks: '/networks',
  'create-network': '/networks/create',
  'network-config': '/networks',
  members: '/members',
  'member-detail': '/members',
  'raw-api': '/api',
  terminal: '/curl',
  settings: '/settings',
};

let routeState = { page: 'dashboard', panel: 'dashboard', path: '/', params: {} };

function matchRoute(pathname) {
  for (const route of ROUTES) {
    const match = pathname.match(route.pattern);
    if (!match) continue;
    const params = {};
    (route.params || []).forEach((key, idx) => { params[key] = decodeURIComponent(match[idx + 1] || ''); });
    return { ...route, path: pathname, params };
  }
  return null;
}

function applyRouteParams(route) {
  const { nwid, id } = route.params || {};
  if (nwid) {
    S.selectedNwid = nwid;
    setVal('configNwid', nwid);
    setVal('membersNwid', nwid);
    setVal('curlNwid', nwid);
  }
  if (id) {
    setVal('detailMemid', id);
    setVal('curlMemId', id);
  }
  if (route.page === 'member-detail' && nwid) {
    setVal('detailNwid', nwid);
  }
}

function navigate(target, options = {}) {
  const resolvedTarget = target.startsWith('/') ? target : (LEGACY_PAGE_TO_PATH[target] || '/');
  const route = matchRoute(resolvedTarget) || matchRoute('/');
  if (!route) return;

  if (!options.fromPopState) {
    const method = options.replace ? 'replaceState' : 'pushState';
    history[method]({}, '', resolvedTarget);
  }

  routeState = route;
  applyRouteParams(route);

  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.mob-nav-item').forEach(n => n.classList.remove('active'));

  const page = route.page;
  const panel = document.getElementById('panel-' + route.panel);
  if (panel) panel.classList.add('active');

  // Sidebar
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.dataset.routeKey === page) n.classList.add('active');
  });

  // Mobile bottom nav
  const mni = document.querySelector(`.mob-nav-item[data-page="${page}"]`);
  if (mni) mni.classList.add('active');

  // FAB: show on networks/members panels
  const fab = document.getElementById('fab');
  fab.style.display = ['networks','members','dashboard'].includes(page) ? 'flex' : 'none';

  // Mobile: scroll to top
  document.getElementById('main').scrollTop = 0;
  closeSidebar();

  // Auto-actions
  if (page === 'terminal') renderCurl();
  if (page === 'network-config' && route.params.nwid) loadNetworkConfig();
  if (page === 'members' && (route.params.nwid || S.selectedNwid)) loadMembers();
  if (page === 'member-detail' && route.params.nwid && route.params.id) loadMemberDetail();
}

function useNavigate() {
  return (to, options = {}) => navigate(to, options);
}

function useParams() {
  return routeState.params || {};
}

// ═══════════════════════════════════════════════════════
//  SIDEBAR
// ═══════════════════════════════════════════════════════
function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const ov = document.getElementById('sidebarOverlay');
  const mb = document.getElementById('menuBtn');
  const open = sb.classList.toggle('open');
  ov.classList.toggle('show', open);
  mb.classList.toggle('open', open);
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show');
  document.getElementById('menuBtn').classList.remove('open');
}

// ═══════════════════════════════════════════════════════
//  FAB
// ═══════════════════════════════════════════════════════
function fabAction() {
  const active = document.querySelector('.panel.active')?.id;
  if (active === 'panel-members') {
    if (S.selectedNwid && getVal('detailMemid')) navigate(`/members/${S.selectedNwid}/${getVal('detailMemid')}`);
    else navigate('/members');
  }
  else navigate('/networks/create');
}

// ═══════════════════════════════════════════════════════
//  API LAYER
// ═══════════════════════════════════════════════════════
async function api(method, path, body, btnId) {
  const btn = btnId ? document.getElementById(btnId) : null;
  if (btn) btn.classList.add('loading');

  try {
    const opts = {
      method,
      headers: { 'X-ZT1-AUTH': S.token, 'Content-Type': 'application/json' }
    };
    if (body && method !== 'GET') opts.body = JSON.stringify(body);
    const res = await fetch(S.host + path, opts);
    let data;
    try { data = await res.json(); } catch { data = null; }
    return { ok: res.ok, status: res.status, data };
  } catch(e) {
    toast('Network error: ' + e.message, 'err');
    return null;
  } finally {
    if (btn) btn.classList.remove('loading');
  }
}

// ═══════════════════════════════════════════════════════
//  CONNECT
// ═══════════════════════════════════════════════════════
async function testConnection(fromMobile) {
  S.host  = getVal(fromMobile ? 'mobApiHost'  : 'apiHost');
  S.token = getVal(fromMobile ? 'mobApiToken' : 'apiToken');
  if (!S.token) { toast('Enter auth token first', 'err'); return; }

  // Sync both inputs
  setVal('apiHost',    S.host);  setVal('mobApiHost',  S.host);
  setVal('settingsHost', S.host); setVal('settingsToken', S.token);

  const btn = document.getElementById('connectBtn');
  if (btn) btn.classList.add('loading');

  const res = await api('GET', '/status');

  if (btn) btn.classList.remove('loading');

  const dot = document.getElementById('statusDot');
  const nid = document.getElementById('headerNodeId');

  if (res && res.ok) {
    S.nodeId = res.data.address || '';
    S.connected = true;
    dot.className = 'status-dot online';
    nid.textContent = S.nodeId;
    savePrefs();
    toast(`Connected · ${S.nodeId}`, 'ok');
    refreshDashboard();
  } else {
    dot.className = 'status-dot error';
    nid.textContent = 'ERROR';
    S.connected = false;
    toast('Connection failed — check host & token', 'err');
  }
}

function testConnectionMobile() { testConnection(true); }

// ═══════════════════════════════════════════════════════
//  DASHBOARD
// ═══════════════════════════════════════════════════════
async function refreshDashboard() {
  if (!S.token) return;
  // Status
  const st = await api('GET', '/status');
  if (st?.ok) {
    const d = st.data;
    S.nodeId = d.address || S.nodeId;
    document.getElementById('headerNodeId').textContent = S.nodeId;
    setVal('statNodeId', S.nodeId, true);
    setVal('statNodeId', ''); // use innerHTML
    document.getElementById('statNodeId').textContent = S.nodeId;
    document.getElementById('dashStatus').innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px">
        ${kv('VERSION', d.version||'—')}
        ${kv('ADDRESS', `<span style="color:var(--accent)">${d.address}</span>`)}
        ${kv('ONLINE',  d.online ? `<span style="color:var(--green)">✓ Online</span>` : `<span style="color:var(--red)">✕ Offline</span>`)}
        ${kv('TCP FALLBACK', d.tcpFallbackActive ? 'Active':'No')}
        ${kv('RELAY POLICY', d.relayPolicy||'—')}
        ${kv('CLOCK', new Date(d.clock).toLocaleTimeString())}
      </div>`;
  }
  // Networks
  await loadNetworksData();
}

function kv(k,v) {
  return `<div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--r-sm);padding:10px">
    <div style="font-size:9px;letter-spacing:.12em;color:#6a9ab8;text-transform:uppercase;margin-bottom:4px">${k}</div>
    <div style="font-size:11px;color:var(--text)">${v}</div>
  </div>`;
}

async function loadNetworksData() {
  const res = await api('GET', '/controller/network');
  if (!res?.ok) return;
  // Fetch names for each network
  const ids = res.data || [];
  S.networks = [];
  for (const id of ids) {
    const nr = await api('GET', `/controller/network/${id}`);
    S.networks.push({ id, name: nr?.data?.name || '', private: nr?.data?.private ?? true, ...nr?.data });
  }
  document.getElementById('statNetworks').textContent = S.networks.length;
  setBadge('netBadge', S.networks.length);
  setBadge('mobNetBadge', S.networks.length, true);
  renderDashNetworks();
  renderNetworksList();

  // Member counts
  let auth = 0, pend = 0;
  for (const nw of S.networks.slice(0, 6)) {
    const mr = await api('GET', `/controller/network/${nw.id}/member`);
    if (mr?.ok) {
      const members = Object.values(mr.data || {});
      auth += members.filter(m => m.authorized).length;
      pend += members.filter(m => !m.authorized).length;
    }
  }
  document.getElementById('statAuthorized').textContent = auth;
  document.getElementById('statPending').textContent = pend;
  setBadge('memBadge', auth + pend);
  setBadge('mobMemBadge', pend, true);
}

function renderDashNetworks() {
  const el = document.getElementById('dashNetworks');
  if (!S.networks.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">⬡</div><div class="empty-title">No networks yet</div>Create your first network to get started</div>';
    return;
  }
  el.innerHTML = S.networks.map(nw => `
    <div class="net-card" onclick="goToNetwork('${nw.id}')">
      <div class="net-id">${nw.id}</div>
      <div class="net-name">${nw.name || '<span style="color:#6a9ab8;font-style:italic">unnamed</span>'}</div>
      <div class="net-meta">
        ${nw.private ? '<span class="badge b-gray">🔒 private</span>' : '<span class="badge b-yellow">🌐 public</span>'}
      </div>
      <div class="net-actions">
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();copyText('${nw.id}')">⎘</button>
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();goToMembers('${nw.id}')">Members</button>
      </div>
    </div>
  `).join('');
}

// ═══════════════════════════════════════════════════════
//  STATUS
// ═══════════════════════════════════════════════════════
async function loadStatus() {
  const res = await api('GET', '/status');
  const el = document.getElementById('statusOutput');
  if (res?.ok) { el.textContent = JSON.stringify(res.data, null, 2); el.className = 'resp ok'; }
  else { el.textContent = 'Error loading status\n\n' + JSON.stringify(res?.data, null, 2); el.className = 'resp err'; }
}

// ═══════════════════════════════════════════════════════
//  NETWORKS
// ═══════════════════════════════════════════════════════
let _allNetworkItems = [];

async function loadNetworks() {
  await loadNetworksData();
  toast('Networks refreshed', 'ok');
}

function renderNetworksList() {
  const el = document.getElementById('networksList');
  _allNetworkItems = S.networks;
  if (!S.networks.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">⬢</div><div class="empty-title">No networks found</div>Create your first ZeroTier network</div>';
    return;
  }
  renderFilteredNetworks(S.networks);
}

function renderFilteredNetworks(list) {
  const el = document.getElementById('networksList');
  if (!list.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">⬡</div>No networks match your filter</div>'; return; }
  el.innerHTML = list.map(nw => `
    <div class="net-card${nw.id === S.selectedNwid ? ' selected' : ''}" onclick="goToNetwork('${nw.id}')">
      <div class="net-id">${nw.id}</div>
      <div class="net-name">${nw.name || '<em style="color:#6a9ab8">unnamed</em>'}</div>
      <div class="net-meta">
        ${nw.private ? '<span class="badge b-gray">🔒</span>' : '<span class="badge b-yellow">🌐</span>'}
      </div>
      <div class="net-actions">
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();copyText('${nw.id}')">⎘ ID</button>
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();goToMembers('${nw.id}')">Members</button>
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();goToNetwork('${nw.id}')">Config</button>
      </div>
    </div>
  `).join('');
}

function filterNetworks() {
  const q = getVal('netSearch').toLowerCase().trim();
  if (!q) { renderFilteredNetworks(_allNetworkItems); return; }
  renderFilteredNetworks(_allNetworkItems.filter(n => n.id.includes(q) || (n.name||'').toLowerCase().includes(q)));
}

function goToNetwork(nwid) {
  S.selectedNwid = nwid;
  setVal('configNwid', nwid);
  navigate(`/networks/${encodeURIComponent(nwid)}`);
}

function goToMembers(nwid) {
  S.selectedNwid = nwid;
  setVal('membersNwid', nwid);
  navigate('/members');
}

// ═══════════════════════════════════════════════════════
//  CREATE NETWORK — own state (N), separate from Configure (S)
// ═══════════════════════════════════════════════════════
const N = {
  pools:  [],
  routes: [],
  v6:     { rfc4193: false, '6plane': false, zt: false },
  selectedEasyRange: null,
};

function fillDefaults() {
  setVal('newNetName', 'my-network');
  // Set Private radio
  const r = document.getElementById('newAclPrivate');
  if (r) { r.checked = true; setNewPrivate(true); }
  // Select easy range 192.168.192.*
  N.selectedEasyRange = null;
  N.pools  = [{ ipRangeStart: '192.168.192.1', ipRangeEnd: '192.168.192.254' }];
  N.routes = [{ target: '192.168.192.0/24', via: null }];
  renderNewPools();
  renderNewRoutes();
  renderNewIpRangeGrid();
  // Switch to Advanced to show the result
  const advTab = document.getElementById('newV4TabBar')?.querySelectorAll('.tab')[1];
  if (advTab) selectNewV4Tab(advTab, 'advanced');
  // Auto-assign ON
  const chk = document.getElementById('newV4Auto');
  if (chk) { chk.checked = true; onNewV4AutoChange(); }
  toast('Defaults applied', 'ok');
}

function setNewPrivate(v) {
  setVal('newNetPrivate', v ? 'true' : 'false');
  // sync radio highlight
  ['private','public'].forEach(k => {
    const el = document.getElementById(`newAcl-${k}`);
    if (el) el.querySelector('.access-radio-body')?.classList.toggle('active-dummy', false);
  });
}

// ── New Network Routes ──
function renderNewRoutes() {
  const el = document.getElementById('newRouteList');
  if (!el) return;
  el.innerHTML = N.routes.length
    ? N.routes.map((r, i) => `
        <div class="route-row">
          <span class="route-tgt" style="font-family:'IBM Plex Mono',monospace">${r.target}</span>
          ${routeTag(r.target)}
          ${r.via
            ? `<span class="badge b-blue" style="font-size:9px">via</span>
               <span class="route-via" style="font-family:'IBM Plex Mono',monospace">${r.via}</span>`
            : `<span class="badge b-gray" style="font-size:9px">direct</span>`}
          <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="removeNewRoute(${i})">✕</button>
        </div>`).join('')
    : '<div style="color:#6a9ab8;font-size:11px;padding:8px 0">No routes — optional, skip if not needed.</div>';
}
function addNewRoute() {
  const t = getVal('newRouteTarget').trim();
  const v = getVal('newRouteVia').trim() || null;
  if (!t) { toast('Enter a route target CIDR', 'err'); return; }
  if (!t.includes('/')) { toast('Target must be a CIDR (e.g. 192.168.0.0/24)', 'err'); return; }
  if (N.routes.some(r => r.target === t)) { toast('Route already exists', 'err'); return; }
  N.routes.push({ target: t, via: v });
  setVal('newRouteTarget', ''); setVal('newRouteVia', '');
  renderNewRoutes();
}
function removeNewRoute(i) { N.routes.splice(i, 1); renderNewRoutes(); }

// ── New Network Pools ──
function renderNewPools() {
  const el = document.getElementById('newPoolList');
  if (!el) return;
  el.innerHTML = N.pools.length
    ? N.pools.map((p, i) => `
        <div class="route-row">
          <span class="route-tgt">${p.ipRangeStart} → ${p.ipRangeEnd}</span>
          <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="removeNewPool(${i})">✕</button>
        </div>`).join('')
    : '<div style="color:#6a9ab8;font-size:11px;padding:8px 0">No pools defined.</div>';
}
function addNewPool() {
  const s = getVal('newPoolStart').trim(), e = getVal('newPoolEnd').trim();
  if (!s || !e) { toast('Enter both start and end IPs', 'err'); return; }
  N.pools.push({ ipRangeStart: s, ipRangeEnd: e });
  setVal('newPoolStart', ''); setVal('newPoolEnd', '');
  renderNewPools();
}
function removeNewPool(i) { N.pools.splice(i, 1); renderNewPools(); }

// ── New Network IPv4 Easy/Advanced tab ──
function onNewV4AutoChange() {
  const on = document.getElementById('newV4Auto')?.checked;
  const sec = document.getElementById('newV4AutoSection');
  if (sec) sec.style.display = on ? '' : 'none';
  if (on) renderNewIpRangeGrid();
}
function selectNewV4Tab(el, tab) {
  el.closest('.tab-bar').querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('newV4TabEasy').style.display     = tab === 'easy'     ? '' : 'none';
  document.getElementById('newV4TabAdvanced').style.display = tab === 'advanced' ? '' : 'none';
  if (tab === 'easy') renderNewIpRangeGrid();
}
function renderNewIpRangeGrid() {
  const grid = document.getElementById('newIpRangeGrid');
  if (!grid) return;
  grid.innerHTML = EASY_RANGES.map((r, i) => `
    <button class="ip-range-btn${N.selectedEasyRange === i ? ' selected' : ''}"
      onclick="selectNewEasyRange(${i})">${r.label}</button>
  `).join('');
}
function selectNewEasyRange(i) {
  N.selectedEasyRange = i;
  const r = EASY_RANGES[i];
  N.pools = [{ ipRangeStart: r.start, ipRangeEnd: r.end }];
  const cidr = r.cidr;
  N.routes = N.routes.filter(rt => rt.target !== cidr);
  N.routes.unshift({ target: cidr, via: null });
  renderNewPools();
  renderNewRoutes();
  renderNewIpRangeGrid();
  toast(`Range ${r.label} applied`, 'ok');
}

// ── New Network IPv6 ──
function onNewV6Change() {
  N.v6.rfc4193  = !!document.getElementById('newV6Rfc')?.checked;
  N.v6['6plane'] = !!document.getElementById('newV66plane')?.checked;
  N.v6.zt       = !!document.getElementById('newV6Zt')?.checked;
}

// ── Exit Node toggle ──
function onExitNodeChange() {
  const on = document.getElementById('newExitNode').checked;
  document.getElementById('exitNodeSection').style.display = on ? '' : 'none';
}

// ── Create Network ──
async function createNetwork() {
  if (!S.nodeId) { toast('Connect first to get your Node ID', 'err'); return; }

  const isPrivate = getVal('newNetPrivate') !== 'false';
  const v4on      = !!document.getElementById('newV4Auto')?.checked;
  const name      = getVal('newNetName').trim();
  const desc      = getVal('newNetDesc').trim();
  const exitOn    = document.getElementById('newExitNode').checked;
  const exitGwHint = getVal('newExitGatewayIp').trim();

  // Determine gateway IP: hint > pool start > fallback
  const gwIp = exitGwHint
    || (N.pools[0]?.ipRangeStart || null);

  // Build routes — add 0.0.0.0/0 if exit node enabled
  const routes = [...N.routes];
  if (exitOn && !routes.some(r => r.target === '0.0.0.0/0')) {
    routes.unshift({ target: '0.0.0.0/0', via: gwIp });
  }

  const body = {
    private:        isPrivate,
    v4AssignMode:   v4on ? { zt: true } : { zt: false },
    v6AssignMode: {
      rfc4193:  N.v6.rfc4193,
      '6plane': N.v6['6plane'],
      zt:       N.v6.zt,
    },
  };
  if (name)               body.name        = name;
  if (desc)               body.description = desc;
  if (N.pools.length)     body.ipAssignmentPools = N.pools;
  if (routes.length)      body.routes      = routes;

  const res = await api('POST', `/controller/network/${S.nodeId}______`, body, 'createNetBtn');
  const resultEl = document.getElementById('createResult');
  resultEl.style.display = 'block';

  if (res?.ok) {
    resultEl.textContent = JSON.stringify(res.data, null, 2);
    resultEl.className = 'resp ok';
    const nwid = res.data.id;
    toast(`Network created: ${nwid}`, 'ok');
    await loadNetworksData();

    if (exitOn) {
      const gw      = gwIp || '&lt;EXIT_NODE_ZT_IP&gt;';
      const iface   = 'zt' + nwid.substring(0, 6);

      // Fill backend API spec
      document.getElementById('backendApiSpec').innerHTML =
`<span class="c"># ══════════════════════════════════════════════════</span>
<span class="c"># Backend API Specification</span>
<span class="c"># Endpoint: POST /api/exit-node/setup</span>
<span class="c"># ══════════════════════════════════════════════════</span>

<span class="c"># REQUEST</span>
<span class="out">POST /api/exit-node/setup
Content-Type: application/json

{
  "nwid":      "${nwid}",
  "nodeId":    "${S.nodeId}",       <span class="c">// controller's own ZT node ID</span>
  "gwIp":      "${gw}",    <span class="c">// IP the exit node should receive</span>
  "ztHost":    "http://localhost:9993",
  "ztToken":   "&lt;X-ZT1-AUTH token&gt;",
  "wanIface":  "eth0"               <span class="c">// WAN interface (auto-detect if omitted)</span>
}</span>

<span class="c"># RESPONSE — success</span>
<span class="out">HTTP 200 OK
{
  "ok":      true,
  "nwid":    "${nwid}",
  "nodeId":  "${S.nodeId}",
  "gwIp":    "${gw}",
  "steps": [
    { "step": "join",        "status": "ok", "output": "200 join OK" },
    { "step": "authorize",   "status": "ok" },
    { "step": "ip_forward",  "status": "ok" },
    { "step": "iptables_nat","status": "ok" },
    { "step": "iptables_fwd","status": "ok" },
    { "step": "persist",     "status": "ok" }
  ]
}</span>

<span class="c"># RESPONSE — error</span>
<span class="out">HTTP 500
{
  "ok":    false,
  "step":  "iptables_nat",
  "error": "Permission denied — run backend as root or with sudo"
}</span>`;

      // Fill manual commands
      document.getElementById('exitNodeCmds').innerHTML =
`<span class="c"># ── 1. Join the network ───────────────────────────────</span>
<span class="p">$</span> <span class="cmd">sudo zerotier-cli join ${nwid}</span>
<span class="out">200 join OK</span>

<span class="c"># ── 2. Authorize this node via ZTNET Tools ────────────</span>
<span class="out">  → Members → find ${S.nodeId} → Authorize ✓</span>

<span class="c">  OR via curl:</span>
<span class="p">$</span> <span class="cmd">curl -X POST http://localhost:9993/controller/network/${nwid}/member/${S.nodeId} \\
  -H "X-ZT1-AUTH: \$TOKEN" \\
  -d '{"authorized":true}'</span>

<span class="c"># ── 3. Enable IP forwarding ───────────────────────────</span>
<span class="p">$</span> <span class="cmd">sudo sysctl -w net.ipv4.ip_forward=1</span>
<span class="p">$</span> <span class="cmd">echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf</span>

<span class="c"># ── 4. Detect interfaces ──────────────────────────────</span>
<span class="p">$</span> <span class="cmd">ZT_IF=$(ip link | grep -o 'zt[a-z0-9]*' | head -1)   # e.g. ${iface}</span>
<span class="p">$</span> <span class="cmd">WAN_IF=$(ip route | awk '/default/{print \$5; exit}')  # e.g. eth0</span>
<span class="p">$</span> <span class="cmd">echo "ZT: \$ZT_IF  WAN: \$WAN_IF"</span>

<span class="c"># ── 5. Configure NAT masquerade ───────────────────────</span>
<span class="p">$</span> <span class="cmd">sudo iptables -t nat -A POSTROUTING -o \$WAN_IF -j MASQUERADE</span>
<span class="p">$</span> <span class="cmd">sudo iptables -A FORWARD -i \$ZT_IF -o \$WAN_IF -j ACCEPT</span>
<span class="p">$</span> <span class="cmd">sudo iptables -A FORWARD -i \$WAN_IF -o \$ZT_IF \\
  -m state --state RELATED,ESTABLISHED -j ACCEPT</span>

<span class="c"># ── 6. Persist iptables rules ─────────────────────────</span>
<span class="p">$</span> <span class="cmd">sudo apt install iptables-persistent -y</span>
<span class="p">$</span> <span class="cmd">sudo netfilter-persistent save</span>

<span class="c"># ── 7. Verify ZeroTier IP = ${gw} ────────────────</span>
<span class="p">$</span> <span class="cmd">zerotier-cli listnetworks</span>
<span class="out">  Network: ${nwid}  IP: ${gw}  Status: OK</span>

<span class="c"># ── Route 0.0.0.0/0 via ${gw} is already set on the controller ✓</span>
<span class="c"># ── Clients: enable "Route all traffic" in their ZeroTier app ──</span>
<span class="c">#    iOS/Android: VPN → Global Network</span>
<span class="c">#    Desktop:     zerotier-cli set ${nwid} allowGlobal=1</span>`;

      document.getElementById('exitNodeSetup').style.display = 'block';
      document.getElementById('exitNodeSetup').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

  } else {
    resultEl.textContent = 'Error:\n' + JSON.stringify(res?.data, null, 2);
    resultEl.className = 'resp err';
  }
}

// ═══════════════════════════════════════════════════════
//  NETWORK CONFIG UI HELPERS
// ═══════════════════════════════════════════════════════

// Predefined IPv4 easy ranges (matching ZeroTier Central)
const EASY_RANGES = [
  { label: '192.168.55.*', start: '192.168.55.1',  end: '192.168.55.254',  cidr: '192.168.55.0/24'  },
  { label: '192.168.66.*', start: '192.168.66.1',  end: '192.168.66.254',  cidr: '192.168.66.0/24'  },
  { label: '10.147.17.*',  start: '10.147.17.1',   end: '10.147.17.254',   cidr: '10.147.17.0/24'   },
  { label: '10.144.*.*',   start: '10.144.0.1',    end: '10.144.255.254',  cidr: '10.144.0.0/16'    },
  { label: '10.147.18.*',  start: '10.147.18.1',   end: '10.147.18.254',   cidr: '10.147.18.0/24'   },
  { label: '10.241.*.*',   start: '10.241.0.1',    end: '10.241.255.254',  cidr: '10.241.0.0/16'    },
  { label: '10.147.19.*',  start: '10.147.19.1',   end: '10.147.19.254',   cidr: '10.147.19.0/24'   },
  { label: '10.242.*.*',   start: '10.242.0.1',    end: '10.242.255.254',  cidr: '10.242.0.0/16'    },
  { label: '10.147.20.*',  start: '10.147.20.1',   end: '10.147.20.254',   cidr: '10.147.20.0/24'   },
  { label: '10.243.*.*',   start: '10.243.0.1',    end: '10.243.255.254',  cidr: '10.243.0.0/16'    },
  { label: '10.244.*.*',   start: '10.244.0.1',    end: '10.244.255.254',  cidr: '10.244.0.0/16'    },
  { label: '172.22.*.*',   start: '172.22.0.1',    end: '172.22.255.254',  cidr: '172.22.0.0/16'    },
  { label: '172.23.*.*',   start: '172.23.0.1',    end: '172.23.255.254',  cidr: '172.23.0.0/16'    },
  { label: '172.24.*.*',   start: '172.24.0.1',    end: '172.24.255.254',  cidr: '172.24.0.0/16'    },
  { label: '172.29.*.*',   start: '172.29.0.1',    end: '172.29.255.254',  cidr: '172.29.0.0/16'    },
  { label: '172.30.*.*',   start: '172.30.0.1',    end: '172.30.255.254',  cidr: '172.30.0.0/16'    },
  { label: '172.25.*.*',   start: '172.25.0.1',    end: '172.25.255.254',  cidr: '172.25.0.0/16'    },
  { label: '172.26.*.*',   start: '172.26.0.1',    end: '172.26.255.254',  cidr: '172.26.0.0/16'    },
  { label: '172.27.*.*',   start: '172.27.0.1',    end: '172.27.255.254',  cidr: '172.27.0.0/16'    },
  { label: '172.28.*.*',   start: '172.28.0.1',    end: '172.28.255.254',  cidr: '172.28.0.0/16'    },
];

let _selectedEasyRange = null;

function renderIpRangeGrid() {
  const grid = document.getElementById('ipRangeGrid');
  if (!grid) return;
  grid.innerHTML = EASY_RANGES.map((r, i) => `
    <button class="ip-range-btn${_selectedEasyRange === i ? ' selected' : ''}"
      onclick="selectEasyRange(${i})">${r.label}</button>
  `).join('');
}

function selectEasyRange(i) {
  _selectedEasyRange = i;
  const r = EASY_RANGES[i];
  // Apply as the single pool
  S.pools = [{ ipRangeStart: r.start, ipRangeEnd: r.end }];
  // Add/replace the corresponding route if not already present
  const cidr = r.cidr;
  S.routes = S.routes.filter(rt => rt.target !== cidr);
  S.routes.unshift({ target: cidr, via: null });
  renderPools();
  renderRoutes();
  renderIpRangeGrid(); // refresh selected state
  // Switch to Advanced tab to show the result
  toast(`Range ${r.label} applied`, 'ok');
}

function selectV4Tab(el, tab) {
  // Update tab bar
  el.closest('.tab-bar').querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('v4TabEasy').style.display     = tab === 'easy'     ? '' : 'none';
  document.getElementById('v4TabAdvanced').style.display = tab === 'advanced' ? '' : 'none';
  if (tab === 'easy') renderIpRangeGrid();
}

function onV4AutoChange(silent) {
  const chk = document.getElementById('cfgV4Auto');
  const on  = chk ? chk.checked : false;
  setVal('cfgV4Mode', on ? 'zt' : 'none');
  const sec = document.getElementById('v4AutoSection');
  if (sec) sec.style.display = on ? '' : 'none';
  if (on && !silent) renderIpRangeGrid();
}

function setPrivate(isPrivate) {
  setVal('cfgPrivate', isPrivate ? 'true' : 'false');
}

// ─── v6 checkbox handlers ───
function onV6Check(mode, checked) {
  v6State[mode] = checked;
  applyV6UI();
}

// Override applyV6UI to sync the checkboxes instead of cards
function applyV6UI() {
  setVal('cfgV6zt',     v6State.zt       ? 'true' : 'false');
  setVal('cfgV6rfc',    v6State.rfc4193  ? 'true' : 'false');
  setVal('cfgV66plane', v6State['6plane']? 'true' : 'false');

  // Sync checkboxes
  const chkRfc    = document.getElementById('v6ChkRfc');
  const chk6plane = document.getElementById('v6Chk6plane');
  const chkZt     = document.getElementById('v6ChkZt');
  if (chkRfc)    chkRfc.checked    = v6State.rfc4193;
  if (chk6plane) chk6plane.checked = v6State['6plane'];
  if (chkZt)     chkZt.checked     = v6State.zt;

  // Also sync legacy cards if still in DOM
  ['zt','rfc4193','6plane'].forEach(m => {
    const card = document.getElementById(`v6card-${m}`);
    const st   = document.getElementById(`v6st-${m}`);
    if (card) card.classList.toggle('active', v6State[m]);
    if (st)   st.textContent = v6State[m] ? 'ON' : 'OFF';
  });

  // Show IPv6 pool section only when zt mode on
  const poolSec  = document.getElementById('v6PoolSection');
  const routeSec = document.getElementById('v6RouteSection');
  if (poolSec)  poolSec.style.display  = v6State.zt ? '' : 'none';
  if (routeSec) routeSec.style.display = (v6State.zt || v6State['6plane']) ? '' : 'none';
}

function setV6FromData(v6) {
  v6State.zt        = !!(v6 && v6.zt);
  v6State.rfc4193   = !!(v6 && v6.rfc4193);
  v6State['6plane'] = !!(v6 && v6['6plane']);
  applyV6UI();
}

// ─── DNS ───
S.dnsServers = [];
S.dnsDomain  = '';

function renderDnsServers() {
  const el = document.getElementById('dnsList');
  if (!el) return;
  if (!(S.dnsServers||[]).length) {
    el.innerHTML = '<div style="color:#6a9ab8;font-size:11px;padding:6px 0">No DNS servers configured.</div>';
    return;
  }
  el.innerHTML = S.dnsServers.map((ip, i) => `
    <div class="dns-server-row">
      <span class="dns-ip">${ip}</span>
      <button class="btn btn-ghost btn-sm" onclick="removeDnsServer(${i})">✕ Remove</button>
    </div>`).join('') + `
    <button class="btn btn-ghost btn-sm" style="margin-top:6px" onclick="clearDnsConfig()">⊗ Clear DNS config</button>`;
}

function addDnsServer() {
  const ip = getVal('cfgDnsInput').trim();
  if (!ip) { toast('Enter a server IP address', 'err'); return; }
  // Basic IP validation
  if (!/^[\d.:]/.test(ip)) { toast('Enter a valid IP address', 'err'); return; }
  S.dnsServers = S.dnsServers || [];
  if (S.dnsServers.includes(ip)) { toast('Server already in list', 'err'); return; }
  S.dnsServers.push(ip);
  setVal('cfgDnsInput', '');
  renderDnsServers();
  toast(`DNS server ${ip} added`, 'ok');
}

function removeDnsServer(i) {
  S.dnsServers.splice(i, 1);
  renderDnsServers();
}

function clearDnsConfig() {
  S.dnsServers = [];
  S.dnsDomain  = '';
  setVal('cfgDnsDomain', '');
  renderDnsServers();
  toast('DNS config cleared', 'ok');
}

// Allow Enter key in DNS input
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('cfgDnsInput')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') addDnsServer();
  });
});

// ═══════════════════════════════════════════════════════
//  IPv6 MODE CARDS
// ═══════════════════════════════════════════════════════
// State for v6 modes (independent booleans, all can be true simultaneously)
const v6State = { zt: false, rfc4193: false, '6plane': false };
// IPv6 pools and routes stored separately from IPv4
S.v6pools  = [];
S.v6routes = [];

function toggleV6Mode(mode) {
  v6State[mode] = !v6State[mode];
  applyV6UI();
}

// ═══════════════════════════════════════════════════════
//  IPv6 POOLS
// ═══════════════════════════════════════════════════════
function renderV6Pools() {
  const el = document.getElementById('v6PoolList');
  if (!el) return;
  el.innerHTML = (S.v6pools||[]).length
    ? S.v6pools.map((p,i) => `
        <div class="route-row">
          <span class="route-tgt" style="font-family:'IBM Plex Mono',monospace;font-size:11px">${p.ipRangeStart}</span>
          <span class="route-via">→</span>
          <span class="route-tgt" style="font-family:'IBM Plex Mono',monospace;font-size:11px">${p.ipRangeEnd}</span>
          <button class="btn btn-danger btn-sm" onclick="removeV6Pool(${i})">✕</button>
        </div>`).join('')
    : '<div style="color:#6a9ab8;font-size:11px;padding:8px 0">No IPv6 pools defined</div>';
}

function addV6Pool() {
  const s = getVal('v6poolStart').trim();
  const e = getVal('v6poolEnd').trim();
  if (!s || !e) { toast('Enter both IPv6 start and end addresses', 'err'); return; }
  if (!s.includes(':') || !e.includes(':')) { toast('Addresses must be valid IPv6 (contain ":")', 'err'); return; }
  S.v6pools = S.v6pools || [];
  S.v6pools.push({ ipRangeStart: s, ipRangeEnd: e });
  setVal('v6poolStart',''); setVal('v6poolEnd','');
  renderV6Pools();
}

function removeV6Pool(i) { S.v6pools.splice(i,1); renderV6Pools(); }

// ═══════════════════════════════════════════════════════
//  IPv6 ROUTES
// ═══════════════════════════════════════════════════════
function renderV6Routes() {
  const el = document.getElementById('v6RouteList');
  if (!el) return;
  el.innerHTML = (S.v6routes||[]).length
    ? S.v6routes.map((r,i) => `
        <div class="route-row">
          <span class="route-tgt" style="font-family:'IBM Plex Mono',monospace;font-size:11px">${r.target}</span>
          ${r.via
            ? `<span class="badge b-blue" style="font-size:9px">via</span>
               <span class="route-via" style="font-family:'IBM Plex Mono',monospace">${r.via}</span>`
            : `<span class="badge b-gray" style="font-size:9px">direct</span>`
          }
          <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="removeV6Route(${i})">✕</button>
        </div>`).join('')
    : '<div style="color:#6a9ab8;font-size:11px;padding:8px 0">No IPv6 routes defined</div>';
}

function addV6Route() {
  const t = getVal('v6routeTarget').trim();
  const v = getVal('v6routeVia').trim() || null;
  if (!t) { toast('Enter IPv6 route target', 'err'); return; }
  if (!t.includes('/')) { toast('Target must be a CIDR (e.g. 2001:db8::/48 or ::/0)', 'err'); return; }
  if (!t.includes(':')) { toast('Use the IPv4 Routes section for IPv4 targets', 'err'); return; }
  S.v6routes = S.v6routes || [];
  if (S.v6routes.some(r => r.target === t)) { toast(`Route ${t} already exists`, 'err'); return; }
  S.v6routes.push({ target: t, via: v });
  setVal('v6routeTarget',''); setVal('v6routeVia','');
  renderV6Routes();
}

function removeV6Route(i) { S.v6routes.splice(i,1); renderV6Routes(); }

// ═══════════════════════════════════════════════════════
//  NETWORK CONFIG
// ═══════════════════════════════════════════════════════
async function loadNetworkConfig() {
  const params = useParams();
  const nwid = (params.nwid || getVal('configNwid')).trim();
  if (!nwid) { toast('Enter a Network ID', 'err'); return; }
  const res = await api('GET', `/controller/network/${nwid}`);
  if (!res?.ok) { toast('Failed to load network config', 'err'); return; }
  S.selectedNwid = nwid;
  const d = res.data;

  // Separate IPv4/IPv6 pools and routes by address family
  const allPools  = d.ipAssignmentPools || [];
  const allRoutes = d.routes || [];
  S.pools    = allPools.filter(p => !p.ipRangeStart?.includes(':'));
  S.v6pools  = allPools.filter(p =>  p.ipRangeStart?.includes(':'));
  S.routes   = allRoutes.filter(r => !r.target?.includes(':'));
  S.v6routes = allRoutes.filter(r =>  r.target?.includes(':'));

  // DNS state
  S.dnsServers = (d.dns && d.dns.servers) ? [...d.dns.servers] : [];
  S.dnsDomain  = (d.dns && d.dns.domain)  ? d.dns.domain : '';

  // Basic fields
  setVal('cfgName',      d.name || '');
  setVal('cfgDesc',      d.description || d.desc || '');
  setVal('cfgMcLimit',   d.multicastLimit ?? 32);
  setVal('cfgDnsDomain', S.dnsDomain);

  // Access control radios
  const isPrivate = d.private !== false;
  setVal('cfgPrivate', isPrivate ? 'true' : 'false');
  const rPriv = document.getElementById('aclPrivate');
  const rPub  = document.getElementById('aclPublic');
  if (rPriv) rPriv.checked = isPrivate;
  if (rPub)  rPub.checked  = !isPrivate;

  // Broadcast toggle
  const bcast = d.enableBroadcast !== false;
  setVal('cfgBroadcast', bcast ? 'true' : 'false');
  const bChk = document.getElementById('cfgBroadcastChk');
  if (bChk) bChk.checked = bcast;

  // IPv4 auto-assign toggle
  const v4 = d.v4AssignMode;
  const v4Auto = !!(v4 && (v4.zt || v4 === 'zt'));
  setVal('cfgV4Mode', v4Auto ? 'zt' : 'none');
  const v4Chk = document.getElementById('cfgV4Auto');
  if (v4Chk) { v4Chk.checked = v4Auto; onV4AutoChange(true); }

  // IPv6 — toggle checkboxes + show/hide sections
  setV6FromData(d.v6AssignMode || {});

  renderPools(); renderRoutes();
  renderV6Pools(); renderV6Routes();
  renderDnsServers();
  document.getElementById('networkConfigForm').style.display = 'block';
  toast(`Config loaded for ${nwid}`, 'ok');
}

function renderPools() {
  document.getElementById('poolList').innerHTML = S.pools.length
    ? S.pools.map((p,i) => `
        <div class="route-row">
          <span class="route-tgt">${p.ipRangeStart} → ${p.ipRangeEnd}</span>
          <button class="btn btn-danger btn-sm" onclick="removePool(${i})">✕</button>
        </div>`).join('')
    : '<div style="color:#6a9ab8;font-size:11px;padding:8px 0">No pools defined</div>';
}

function routeTag(target) {
  if (target === '0.0.0.0/0' || target === '::/0')
    return '<span class="route-tag dflt">default</span>';
  // Check if overlaps public space (rough heuristic)
  const pub = !target.startsWith('10.') && !target.startsWith('192.168.') &&
              !target.startsWith('172.') && !target.startsWith('fd') && !target.includes(':');
  if (pub) return '<span class="route-tag pub">⚠ public</span>';
  return '<span class="route-tag lan">LAN</span>';
}

function renderRoutes() {
  document.getElementById('routeList').innerHTML = S.routes.length
    ? S.routes.map((r,i) => `
        <div class="route-row">
          <span class="route-tgt" style="font-family:'IBM Plex Mono',monospace">${r.target}</span>
          ${routeTag(r.target)}
          ${r.via
            ? `<span class="badge b-blue" style="font-size:9px">via</span>
               <span class="route-via" style="font-family:'IBM Plex Mono',monospace">${r.via}</span>`
            : `<span class="badge b-gray" style="font-size:9px">direct</span>`
          }
          <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="removeRoute(${i})">✕</button>
        </div>`).join('')
    : '<div style="color:#6a9ab8;font-size:11px;padding:8px 0">No routes defined yet.</div>';
}

function addPool() {
  const s = getVal('poolStart').trim(), e = getVal('poolEnd').trim();
  if (!s || !e) { toast('Enter both start and end IPs', 'err'); return; }
  S.pools.push({ ipRangeStart: s, ipRangeEnd: e });
  setVal('poolStart',''); setVal('poolEnd','');
  renderPools();
}

function removePool(i) { S.pools.splice(i,1); renderPools(); }

function addRoute() {
  const t = getVal('routeTarget').trim();
  const v = getVal('routeVia').trim() || null;
  if (!t) { toast('Enter route target CIDR', 'err'); return; }
  if (!t.includes('/')) { toast('Target must be a CIDR (e.g. 192.168.1.0/24)', 'err'); return; }
  if (S.routes.some(r => r.target === t)) { toast(`Route ${t} already exists`, 'err'); return; }
  S.routes.push({ target: t, via: v });
  setVal('routeTarget',''); setVal('routeVia','');
  renderRoutes();
}

function removeRoute(i) { S.routes.splice(i,1); renderRoutes(); }

async function saveNetworkConfig() {
  const nwid = getVal('configNwid').trim();
  if (!nwid) { toast('Select a network first', 'err'); return; }

  const v4mode = getVal('cfgV4Mode');
  const allPools  = [...(S.pools || []), ...(S.v6pools || [])];
  const allRoutes = [...(S.routes || []), ...(S.v6routes || [])];

  // Build DNS object — only include if domain is set
  const dnsDomain = getVal('cfgDnsDomain').trim();
  const dnsObj = dnsDomain
    ? { domain: dnsDomain, servers: S.dnsServers || [] }
    : { domain: '', servers: [] };

  const body = {
    name:             getVal('cfgName'),
    description:      getVal('cfgDesc'),
    private:          getVal('cfgPrivate') === 'true',
    enableBroadcast:  getVal('cfgBroadcast') === 'true',
    multicastLimit:   parseInt(getVal('cfgMcLimit')) || 32,
    v4AssignMode:     v4mode === 'zt' ? { zt: true } : { zt: false },
    v6AssignMode: {
      zt:       v6State.zt,
      rfc4193:  v6State.rfc4193,
      '6plane': v6State['6plane'],
    },
    ipAssignmentPools: allPools,
    routes:            allRoutes,
    dns:               dnsObj,
  };

  const res = await api('POST', `/controller/network/${nwid}`, body, 'saveNetBtn');
  const el = document.getElementById('configResult');
  el.style.display = 'block';
  if (res?.ok) {
    el.textContent = JSON.stringify(res.data, null, 2);
    el.className = 'resp ok';
    toast('Network saved!', 'ok');
    await loadNetworksData();
  } else {
    el.textContent = 'Error:\n' + JSON.stringify(res?.data, null, 2);
    el.className = 'resp err';
  }
}
async function deleteNetwork() {
  const nwid = getVal('configNwid').trim();
  if (!confirm(`Permanently delete network ${nwid}?\nThis cannot be undone.`)) return;
  const res = await api('DELETE', `/controller/network/${nwid}`);
  if (res?.ok || res?.status === 200) {
    toast('Network deleted', 'ok');
    document.getElementById('networkConfigForm').style.display = 'none';
    S.networks = S.networks.filter(n => n.id !== nwid);
    await loadNetworksData();
    navigate('/networks');
  } else {
    toast('Delete failed', 'err');
  }
}

// ═══════════════════════════════════════════════════════
//  NETWORK PICKER MODAL
// ═══════════════════════════════════════════════════════
let _pickerTarget = null, _pickerCb = null;

function openNetworkPicker(targetId, cb) {
  if (!S.networks.length) { toast('No networks loaded — refresh first', 'err'); return; }
  _pickerTarget = targetId; _pickerCb = cb;
  renderPickerList(S.networks);
  setVal('pickerSearch','');
  const m = document.getElementById('pickerModal');
  m.style.display = 'flex';
}
function closePicker() { document.getElementById('pickerModal').style.display = 'none'; }
function pickNetwork(id) {
  if (_pickerTarget) setVal(_pickerTarget, id);
  closePicker();
  if (_pickerCb) _pickerCb();
}
function renderPickerList(list) {
  document.getElementById('pickerList').innerHTML = list.map(nw => `
    <div onclick="pickNetwork('${nw.id}')" style="padding:12px 16px;cursor:pointer;border-radius:var(--r-sm);transition:background var(--transition);display:flex;flex-direction:column;gap:3px;margin-bottom:2px" onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''">
      <span style="font-size:12px;color:var(--accent);font-family:'IBM Plex Mono',monospace;font-weight:600">${nw.id}</span>
      <span style="font-size:11px;color:#90b8d0">${nw.name || '<em style="color:#6a9ab8">unnamed</em>'}</span>
    </div>`).join('');
}
function filterPicker() {
  const q = getVal('pickerSearch').toLowerCase();
  renderPickerList(S.networks.filter(n => n.id.includes(q) || (n.name||'').toLowerCase().includes(q)));
}

// ═══════════════════════════════════════════════════════
//  MEMBERS
// ═══════════════════════════════════════════════════════
async function loadMembers() {
  const params = useParams();
  const nwid = (params.nwid || getVal('membersNwid')).trim() || S.selectedNwid;
  if (!nwid) { toast('Enter or select a Network ID', 'err'); return; }
  S.selectedNwid = nwid;
  setVal('membersNwid', nwid);

  const res = await api('GET', `/controller/network/${nwid}/member`);
  if (!res?.ok) { toast('Failed to load members', 'err'); return; }

  const members = Object.entries(res.data || {});
  setBadge('memBadge', members.length);
  setBadge('mobMemBadge', members.filter(([,m])=>!m.authorized).length, true);

  const tbody = document.getElementById('membersTable');
  const mobList = document.getElementById('membersMobileList');

  if (!members.length) {
    const empty = '<div class="empty"><div class="empty-icon">◎</div><div class="empty-title">No members yet</div>Join the network from another device to see members here</div>';
    tbody.innerHTML = `<tr><td colspan="6">${empty}</td></tr>`;
    mobList.innerHTML = empty;
    mobList.classList.remove('hidden');
    return;
  }

  // Desktop table
  tbody.innerHTML = members.map(([memid, m]) => `
    <tr>
      <td class="mono">${memid}</td>
      <td>${m.name || `<span style="color:#6a9ab8">—</span>`}</td>
      <td class="mono">${(m.ipAssignments||[]).join(', ') || `<span style="color:#6a9ab8">none</span>`}</td>
      <td class="tbl-hide-mob mono">${m.clientVersion||'—'}</td>
      <td>
        <label class="toggle" title="${m.authorized?'Authorized':'Unauthorized'}">
          <input type="checkbox" ${m.authorized?'checked':''} onchange="qToggleAuth('${nwid}','${memid}',this.checked)">
          <div class="toggle-track"><div class="toggle-thumb"></div></div>
        </label>
      </td>
      <td>
        <div class="flex gap-6">
          <button class="btn btn-ghost btn-sm" onclick="openMemberDetail('${nwid}','${memid}')">→ Detail</button>
          <button class="btn btn-danger btn-sm" onclick="qDeleteMember('${nwid}','${memid}')">✕</button>
        </div>
      </td>
    </tr>`).join('');

  // Mobile cards
  mobList.innerHTML = members.map(([memid, m]) => `
    <div class="card mb-8" style="padding:14px">
      <div class="flex items-ctr gap-8 mb-8">
        <span style="font-size:12px;color:var(--accent);font-family:'IBM Plex Mono',monospace;font-weight:600;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis">${memid}</span>
        <span class="badge ${m.authorized ? 'b-green' : 'b-red'}">${m.authorized ? '✓ auth' : '✕ pending'}</span>
      </div>
      ${m.name ? `<div style="font-size:11px;color:#90b8d0;margin-bottom:6px">${m.name}</div>` : ''}
      <div style="font-size:10px;color:#6a9ab8;margin-bottom:10px">${(m.ipAssignments||[]).join(', ') || 'No IPs assigned'}</div>
      <div class="flex gap-6">
        <label class="toggle">
          <input type="checkbox" ${m.authorized?'checked':''} onchange="qToggleAuth('${nwid}','${memid}',this.checked)">
          <div class="toggle-track"><div class="toggle-thumb"></div></div>
        </label>
        <span style="font-size:11px;color:#6a9ab8;align-self:center">${m.authorized?'Authorized':'Unauthorized'}</span>
        <button class="btn btn-ghost btn-sm ml-auto" onclick="openMemberDetail('${nwid}','${memid}')">Detail →</button>
        <button class="btn btn-danger btn-sm" onclick="qDeleteMember('${nwid}','${memid}')">✕</button>
      </div>
    </div>`).join('');
  mobList.classList.remove('hidden');
  toast(`Loaded ${members.length} members`, 'ok');
}

async function qToggleAuth(nwid, memid, authorized) {
  const res = await api('POST', `/controller/network/${nwid}/member/${memid}`, { authorized });
  if (res?.ok) toast(authorized ? `Authorized ${memid}` : `Deauthorized ${memid}`, 'ok');
  else { toast('Failed to update member', 'err'); loadMembers(); }
}

async function qDeleteMember(nwid, memid) {
  if (!confirm(`Deauthorize and delete member ${memid}?`)) return;
  await api('POST', `/controller/network/${nwid}/member/${memid}`, { authorized: false });
  const res = await api('DELETE', `/controller/network/${nwid}/member/${memid}`);
  if (res?.ok) { toast('Member deleted', 'ok'); loadMembers(); }
  else toast('Delete failed', 'err');
}

function openMemberDetail(nwid, memid) {
  setVal('detailNwid', nwid);
  setVal('detailMemid', memid);
  navigate(`/members/${encodeURIComponent(nwid)}/${encodeURIComponent(memid)}`);
}

// ═══════════════════════════════════════════════════════
//  MEMBER DETAIL
// ═══════════════════════════════════════════════════════
async function loadMemberDetail() {
  const params = useParams();
  const nwid  = (params.nwid || getVal('detailNwid')).trim();
  const memid = (params.id || getVal('detailMemid')).trim();
  if (!nwid || !memid) { toast('Enter Network ID and Member ID', 'err'); return; }
  const res = await api('GET', `/controller/network/${nwid}/member/${memid}`);
  if (!res?.ok) { toast('Failed to load member', 'err'); return; }
  const m = res.data;
  S.memberIps = m.ipAssignments || [];

  setVal('memId',          m.id || memid);
  setVal('memName',        m.name || '');
  setVal('memAuth',        m.authorized ? 'true' : 'false');
  setVal('memBridge',      m.activeBridge ? 'true' : 'false');
  setVal('memCapabilities',(m.capabilities||[]).join(' '));
  setVal('memTags',        (m.tags||[]).map(t=>`${t[0]}=${t[1]}`).join(' '));

  document.getElementById('memberRaw').textContent = JSON.stringify(m, null, 2);
  renderMemberIps();
  document.getElementById('memberDetailPanel').style.display = 'block';
  toast('Member loaded', 'ok');
}

function renderMemberIps() {
  document.getElementById('memIpTags').innerHTML = S.memberIps.map((ip,i) => `
    <span class="ip-tag">${ip}<button onclick="removeMemberIp(${i})" title="Remove">✕</button></span>`).join('');
}

function addMemberIp() {
  const ip = getVal('memIpInput').trim();
  if (!ip) return;
  S.memberIps.push(ip);
  setVal('memIpInput','');
  renderMemberIps();
}

function removeMemberIp(i) { S.memberIps.splice(i,1); renderMemberIps(); }

async function saveMember() {
  const nwid  = getVal('detailNwid').trim();
  const memid = getVal('detailMemid').trim();
  const tags  = getVal('memTags').trim().split(/\s+/).filter(Boolean).map(s => {
    const [id, val] = s.split('='); return [parseInt(id), parseInt(val||0)];
  });
  const body = {
    name:          getVal('memName'),
    authorized:    getVal('memAuth') === 'true',
    activeBridge:  getVal('memBridge') === 'true',
    ipAssignments: S.memberIps,
    capabilities:  getVal('memCapabilities').trim().split(/\s+/).filter(Boolean).map(Number).filter(n=>!isNaN(n)),
    tags,
  };
  const res = await api('POST', `/controller/network/${nwid}/member/${memid}`, body, 'saveMemberBtn');
  if (res?.ok) {
    toast('Member saved!', 'ok');
    document.getElementById('memberRaw').textContent = JSON.stringify(res.data, null, 2);
  } else toast('Failed to save member', 'err');
}

async function authorizeMember(auth) {
  const nwid  = getVal('detailNwid').trim();
  const memid = getVal('detailMemid').trim();
  const res = await api('POST', `/controller/network/${nwid}/member/${memid}`, { authorized: auth });
  if (res?.ok) {
    toast(auth ? 'Member authorized!' : 'Member deauthorized', 'ok');
    setVal('memAuth', auth ? 'true' : 'false');
  }
}

async function deleteMember() {
  const nwid  = getVal('detailNwid').trim();
  const memid = getVal('detailMemid').trim();
  if (!confirm(`Delete member ${memid}? They will be deauthorized first.`)) return;
  await api('POST', `/controller/network/${nwid}/member/${memid}`, { authorized: false });
  const res = await api('DELETE', `/controller/network/${nwid}/member/${memid}`);
  if (res?.ok) {
    toast('Member deleted', 'ok');
    document.getElementById('memberDetailPanel').style.display = 'none';
    navigate('/members');
    await loadMembers();
  } else toast('Delete failed', 'err');
}

// ═══════════════════════════════════════════════════════
//  RAW API
// ═══════════════════════════════════════════════════════
async function sendRawRequest() {
  const method  = getVal('rawMethod');
  const path    = getVal('rawPath').trim();
  const rawBody = getVal('rawBody').trim();
  let body;
  if (rawBody) { try { body = JSON.parse(rawBody); } catch { toast('Invalid JSON body', 'err'); return; } }
  const res = await api(method, path, body, 'rawSendBtn');
  const el = document.getElementById('rawResponse');
  document.getElementById('rawStatus').textContent = res ? `HTTP ${res.status}` : 'error';
  if (res) {
    el.textContent = `HTTP ${res.status}\n\n` + JSON.stringify(res.data, null, 2);
    el.className = 'resp ' + (res.ok ? 'ok' : 'err');
  }
}

function qApi(m, p) { setVal('rawMethod', m); setVal('rawPath', p); navigate('/api'); sendRawRequest(); }
function qApiNet() {
  const nwid = S.selectedNwid || S.networks[0]?.id;
  if (!nwid) { toast('Select a network first', 'err'); return; }
  qApi('GET', `/controller/network/${nwid}`);
}
function qApiMem() {
  const nwid = S.selectedNwid || S.networks[0]?.id;
  if (!nwid) { toast('Select a network first', 'err'); return; }
  qApi('GET', `/controller/network/${nwid}/member`);
}

// ═══════════════════════════════════════════════════════
//  CURL BUILDER
// ═══════════════════════════════════════════════════════
const curlTpls = {
  'curl-status': () => `<span class="c"># ── Get controller status & Node ID ─────────────</span>
<span class="p">$</span> <span class="cmd">curl "${cv('host')}/status" \\
  -H "X-ZT1-AUTH: ${cv('token')}"</span>`,

  'curl-list-nets': () => `<span class="c"># ── List all managed networks ────────────────────</span>
<span class="p">$</span> <span class="cmd">curl "${cv('host')}/controller/network" \\
  -H "X-ZT1-AUTH: ${cv('token')}"</span>`,

  'curl-create-net': () => `<span class="c"># ── Create a new network (auto-generates ID) ─────</span>
<span class="p">$</span> <span class="cmd">curl -X POST \\
  "${cv('host')}/controller/network/${cv('nodeId')}______" \\
  -H "X-ZT1-AUTH: ${cv('token')}" \\
  -d '{"ipAssignmentPools":[{"ipRangeStart":"192.168.192.1","ipRangeEnd":"192.168.192.254"}],"routes":[{"target":"192.168.192.0/24","via":null}],"v4AssignMode":{"zt":true},"private":true,"name":"my-network"}'</span>`,

  'curl-get-net': () => `<span class="c"># ── Get network details ──────────────────────────</span>
<span class="p">$</span> <span class="cmd">curl "${cv('host')}/controller/network/${cv('nwid')}" \\
  -H "X-ZT1-AUTH: ${cv('token')}"</span>`,

  'curl-config-net': () => `<span class="c"># ── Update network configuration ─────────────────</span>
<span class="p">$</span> <span class="cmd">curl -X POST \\
  "${cv('host')}/controller/network/${cv('nwid')}" \\
  -H "X-ZT1-AUTH: ${cv('token')}" \\
  -d '{"name":"updated-name","private":true,"multicastLimit":32}'</span>

<span class="c"># ── Delete network ────────────────────────────────</span>
<span class="p">$</span> <span class="cmd">curl -X DELETE \\
  "${cv('host')}/controller/network/${cv('nwid')}" \\
  -H "X-ZT1-AUTH: ${cv('token')}"</span>`,

  'curl-list-mem': () => `<span class="c"># ── List network members ─────────────────────────</span>
<span class="p">$</span> <span class="cmd">curl "${cv('host')}/controller/network/${cv('nwid')}/member" \\
  -H "X-ZT1-AUTH: ${cv('token')}"</span>

<span class="c"># ── Get specific member ───────────────────────────</span>
<span class="p">$</span> <span class="cmd">curl "${cv('host')}/controller/network/${cv('nwid')}/member/${cv('memId')}" \\
  -H "X-ZT1-AUTH: ${cv('token')}"</span>`,

  'curl-auth-mem': () => `<span class="c"># ── Authorize a member ───────────────────────────</span>
<span class="p">$</span> <span class="cmd">curl -X POST \\
  "${cv('host')}/controller/network/${cv('nwid')}/member/${cv('memId')}" \\
  -H "X-ZT1-AUTH: ${cv('token')}" \\
  -d '{"authorized":true}'</span>

<span class="c"># ── Deauthorize a member ──────────────────────────</span>
<span class="p">$</span> <span class="cmd">curl -X POST \\
  "${cv('host')}/controller/network/${cv('nwid')}/member/${cv('memId')}" \\
  -H "X-ZT1-AUTH: ${cv('token')}" \\
  -d '{"authorized":false}'</span>`,

  'curl-del-mem': () => `<span class="c"># ⚠ Deauthorize FIRST, then delete ───────────────</span>
<span class="p">$</span> <span class="cmd">curl -X POST \\
  "${cv('host')}/controller/network/${cv('nwid')}/member/${cv('memId')}" \\
  -H "X-ZT1-AUTH: ${cv('token')}" \\
  -d '{"authorized":false}'</span>

<span class="p">$</span> <span class="cmd">curl -X DELETE \\
  "${cv('host')}/controller/network/${cv('nwid')}/member/${cv('memId')}" \\
  -H "X-ZT1-AUTH: ${cv('token')}"</span>`,
};

let activeCurlTab = 'curl-status';

function cv(k) {
  const m = {
    host:   () => getVal('curlHost')   || S.host  || 'http://localhost:9993',
    token:  () => getVal('curlToken')  || S.token || 'YOUR_TOKEN',
    nwid:   () => getVal('curlNwid')   || S.selectedNwid || 'NETWORK_ID',
    nodeId: () => getVal('curlNodeId') || S.nodeId || 'YOUR_NODE_ID',
    memId:  () => getVal('curlMemId')  || 'MEMBER_ID',
  };
  return m[k] ? m[k]() : k.toUpperCase();
}

function renderCurl() {
  const fn = curlTpls[activeCurlTab];
  if (fn) document.getElementById('curlOutput').innerHTML = fn();
}

function selectCurlTab(el, tabId) {
  document.querySelectorAll('#curlTabBar .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  activeCurlTab = tabId;
  renderCurl();
}

function copyCurl() {
  copyText(document.getElementById('curlOutput').innerText);
}

function syncCurlVars() {
  setVal('curlHost',   getVal('apiHost')   || S.host);
  setVal('curlToken',  getVal('apiToken')  || S.token);
  setVal('curlNodeId', S.nodeId);
  setVal('curlNwid',   S.selectedNwid);
  renderCurl();
  toast('Variables synced', 'ok');
}

// ═══════════════════════════════════════════════════════
//  SETTINGS
// ═══════════════════════════════════════════════════════
function applySettings() {
  S.host  = getVal('settingsHost').trim();
  S.token = getVal('settingsToken').trim();
  setVal('apiHost',    S.host);
  setVal('apiToken',   S.token);
  setVal('mobApiHost', S.host);
  setVal('mobApiToken', S.token);
  document.getElementById('settingsStatus').innerHTML = '<span style="color:#6a9ab8"><span class="spinner"></span> Testing connection...</span>';
  testConnection().then(() => {
    document.getElementById('settingsStatus').textContent = S.connected
      ? `✓ Connected to ${S.host}` : '✕ Connection failed';
  });
}

function clearSettings() {
  ['settingsHost','settingsToken','apiHost','apiToken','mobApiHost','mobApiToken'].forEach(id => setVal(id,''));
  S.host = S.token = '';
  document.getElementById('settingsStatus').textContent = 'Cleared.';
  try { localStorage.removeItem('ztnet_host'); localStorage.removeItem('ztnet_token'); } catch{}
}

// ═══════════════════════════════════════════════════════
//  TOAST
// ═══════════════════════════════════════════════════════
function toast(msg, type = 'ok') {
  const w = document.getElementById('toast-wrap');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  const icon = type === 'ok'
    ? `<span style="color:var(--green);flex-shrink:0">✓</span>`
    : `<span style="color:var(--red);flex-shrink:0">✕</span>`;
  el.innerHTML = `${icon} ${msg}`;
  w.appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

// ═══════════════════════════════════════════════════════
//  UTILITIES
// ═══════════════════════════════════════════════════════
function getVal(id) { return document.getElementById(id)?.value ?? ''; }
function setVal(id, v) { const el = document.getElementById(id); if (el) el.value = v; }
function setBadge(id, n, asAlert = false) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = n;
  if (asAlert) { el.classList.toggle('show', n > 0); }
}
function copyText(text) {
  navigator.clipboard?.writeText(text)
    .then(() => toast('Copied!', 'ok'))
    .catch(() => { /* fallback */ const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); toast('Copied!','ok'); });
}
function copyEl(id) { copyText(document.getElementById(id)?.textContent || ''); }

// ═══════════════════════════════════════════════════════
//  KEYBOARD SHORTCUTS
// ═══════════════════════════════════════════════════════
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closePicker(); closeSidebar(); }
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    if (S.networks.length) openNetworkPicker('configNwid', loadNetworkConfig);
  }
});

// ═══════════════════════════════════════════════════════
//  TUNNEL BLOCKS (collapsible)
// ═══════════════════════════════════════════════════════
function toggleTunnel(id) {
  const block = document.getElementById(id);
  if (block) block.classList.toggle('open');
}

// ═══════════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
  loadPrefs();
  renderCurl();

  // Init Create Network UI
  renderNewRoutes();
  renderNewPools();
  onNewV4AutoChange(); // show IPv4 section (default: on)
  renderNewIpRangeGrid();

  // Live curl re-render on variable change
  ['curlHost','curlToken','curlNwid','curlNodeId','curlMemId'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', renderCurl);
  });

  // Sync mobile conn inputs with desktop
  document.getElementById('mobApiHost')?.addEventListener('input', e => setVal('apiHost', e.target.value));
  document.getElementById('mobApiToken')?.addEventListener('input', e => setVal('apiToken', e.target.value));

  // Auto-connect if token exists
  if (S.token) {
    setTimeout(() => testConnection(), 300);
  }

  // Enter key to connect
  ['apiHost','apiToken','mobApiHost','mobApiToken'].forEach(id => {
    document.getElementById(id)?.addEventListener('keydown', e => {
      if (e.key === 'Enter') testConnection(id.startsWith('mob'));
    });
  });

  const appNavigate = useNavigate();
  appNavigate(location.pathname || '/', { replace: true });
});

window.addEventListener('popstate', () => {
  navigate(location.pathname || '/', { fromPopState: true });
});
</script>
</body>
</html>
